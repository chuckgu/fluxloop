{#- ============================================
    MACROS - Í≥µÌÜµ Ïª¥Ìè¨ÎÑåÌä∏
============================================ -#}

{#- Gauge Ïª¥Ìè¨ÎÑåÌä∏: ÏõêÌòï Í≤åÏù¥ÏßÄ -#}
{% macro gauge(metric) %}
{#- stroke-dashoffset Í≥ÑÏÇ∞: 364.4 * (1 - percent/100) -#}
{% set circumference = 364.4 %}
{% set offset = circumference * (1 - metric.percent / 100) %}
<div class="gauge-item">
    <div class="gauge">
        <svg width="140" height="140" viewBox="0 0 140 140">
            <circle class="gauge-bg" cx="70" cy="70" r="58"></circle>
            <circle
                class="gauge-fill {{ metric.status }}"
                cx="70" cy="70" r="58"
                stroke-dasharray="{{ circumference }}"
                stroke-dashoffset="{{ offset }}"
            ></circle>
        </svg>
        <div class="gauge-center">
            <div class="gauge-value">{{ metric.percent }}%</div>
        </div>
    </div>
    <div class="gauge-label">
        {{ metric.name }}
        <div class="gauge-detail">{{ metric.passed }}/{{ metric.total }} {{ metric.pass_label }}</div>
    </div>
    <span class="gauge-status {{ metric.status }}">{{ metric.status_icon }} {{ metric.status_label }}</span>
</div>
{% endmacro %}

{#- Metric Badge Ïª¥Ìè¨ÎÑåÌä∏ -#}
{% macro metric_badge(badge) %}
{% if badge.style is defined and badge.style %}
<span class="metric-badge" style="{{ badge.style }}">{{ badge.icon }} {{ badge.label }}</span>
{% else %}
<span class="metric-badge {{ badge.status }}">{{ badge.icon }} {{ badge.label }}</span>
{% endif %}
{% endmacro %}

{#- Conversation Turn Ïª¥Ìè¨ÎÑåÌä∏ -#}
{% macro conv_turn(turn) %}
<div class="conv-turn">
    <span class="conv-role {{ turn.role }}">{% if turn.turn is defined %}Turn {{ turn.turn }}:{% elif turn.role == 'user' %}User:{% else %}Agent:{% endif %}</span>
    <span class="conv-text">{{ turn.text | safe }}</span>
</div>
{% endmacro %}

{#- Recommendation Box Ïª¥Ìè¨ÎÑåÌä∏ -#}
{% macro recommendation_box(text, icon="üí°") %}
<div class="recommendation-box">
    <span class="recommendation-icon">{{ icon }}</span>
    <span class="recommendation-text">{{ text | safe }}</span>
</div>
{% endmacro %}

{#- Trace ID Ìè¨Îß∑ÌåÖ Îß§ÌÅ¨Î°ú -#}
{#- short: 6ÏûêÎ¶¨ + ... (Overview attention table) -#}
{% macro trace_short(id) %}{{ id[:6] }}{% if id|length > 6 %}...{% endif %}{% endmacro %}
{#- medium: 12ÏûêÎ¶¨ + ... (Trace Matrix, Insights table, Recommendations) -#}
{% macro trace_medium(id) %}{{ id[:12] }}{% if id|length > 12 %}...{% endif %}{% endmacro %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxloop Simulation Report - {{ meta.agent_name }}</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 12a1 1 0 0 1-10 0 1 1 0 0 0-10 0'/%3E%3Cpath d='M7 20.7a1 1 0 1 1 5-8.7 1 1 0 1 0 5-8.6'/%3E%3Cpath d='M7 3.3a1 1 0 1 1 5 8.6 1 1 0 1 0 5 8.6'/%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-color: #f9fafb;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --hover-bg: #f3f4f6;
        }

        .dark-mode {
            --bg-color: #111827;
            --text-color: #f9fafb;
            --border-color: #374151;
            --sidebar-bg: #1f2937;
            --card-bg: #374151;
            --hover-bg: #4b5563;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Layout */
        .container {
            display: flex;
            margin-top: 0;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 220px;
            height: 100vh;
            transition: width 0.3s ease;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 1rem 0 1.5rem 0;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section h3 {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #6b7280;
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        .nav-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .nav-item:hover {
            background-color: var(--hover-bg);
        }

        .nav-item.active {
            background-color: var(--primary-color);
            color: white;
            border-left: 3px solid #1d4ed8;
        }

        .nav-badge {
            margin-left: auto;
            padding: 0.2rem 0.5rem;
            background-color: var(--danger-color);
            color: white;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Main Content */
        .main-content {
            margin-left: 220px;
            flex: 1;
            padding: 2rem;
            max-width: calc(100% - 220px);
            transition: margin-left 0.3s ease, max-width 0.3s ease;
        }

        /* Sidebar Collapsed State */
        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar.collapsed .nav-section h3 {
            display: none;
        }

        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 0.75rem;
        }

        .sidebar.collapsed .nav-item-text {
            display: none;
        }

        .main-content.sidebar-collapsed {
            margin-left: 60px;
            max-width: calc(100% - 60px);
        }

        /* Sidebar Header */
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            margin-bottom: 8px;
        }

        .sidebar-logo {
            font-weight: 700;
            font-size: 16px;
            color: var(--text-color);
            white-space: nowrap;
        }

        .sidebar.collapsed .sidebar-header {
            justify-content: center;
            padding: 12px 8px;
        }

        .sidebar.collapsed .sidebar-logo {
            display: none;
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 6px;
            background: var(--card-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .sidebar-toggle:hover {
            background: var(--hover-bg);
        }

        .sidebar-toggle i {
            width: 14px;
            height: 14px;
        }

        .sidebar-toggle svg {
            stroke-width: 1.5;
        }

        /* Cards */
        .card {
            background-color: transparent;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 2rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
        }

        /* Status Badges */
        .badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background-color: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .dark-mode .badge-success {
            background-color: #065f46;
            color: #d1fae5;
        }

        .dark-mode .badge-danger {
            background-color: #991b1b;
            color: #fee2e2;
        }

        .dark-mode .badge-warning {
            background-color: #92400e;
            color: #fef3c7;
        }

        .dark-mode .badge-info {
            background-color: #1e40af;
            color: #dbeafe;
        }

        /* Alert Boxes */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
        }

        .alert-critical {
            background-color: #fee2e2;
            border-color: var(--danger-color);
            color: #991b1b;
        }

        .alert-warning {
            background-color: #fef3c7;
            border-color: var(--warning-color);
            color: #92400e;
        }

        .alert-success {
            background-color: #d1fae5;
            border-color: var(--success-color);
            color: #065f46;
        }

        .alert-info {
            background-color: #dbeafe;
            border-color: var(--primary-color);
            color: #1e40af;
        }

        .dark-mode .alert-critical {
            background-color: #7f1d1d;
            color: #fee2e2;
        }

        .dark-mode .alert-warning {
            background-color: #78350f;
            color: #fef3c7;
        }

        .dark-mode .alert-success {
            background-color: #064e3b;
            color: #d1fae5;
        }

        .dark-mode .alert-info {
            background-color: #1e3a8a;
            color: #dbeafe;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin: 1rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            background-color: var(--sidebar-bg);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background-color: var(--hover-bg);
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background-color: var(--hover-bg);
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1.5rem 0;
        }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin: 1.5rem 0;
        }

        /* Collapsible Sections */
        .collapsible {
            cursor: pointer;
            padding: 1rem;
            background-color: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .collapsible:hover {
            background-color: var(--hover-bg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 1rem;
        }

        .collapsible-content.active {
            max-height: 5000px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 6px 6px;
            margin-bottom: 1rem;
        }

        .chevron {
            transition: transform 0.3s;
        }

        .chevron.active {
            transform: rotate(180deg);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #6b7280;
        }

        select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .metric-card.non-clickable {
            cursor: default;
        }

        .metric-card.non-clickable:hover {
            transform: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0.5rem 0;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-change {
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .metric-change.positive {
            color: var(--success-color);
        }

        .metric-change.negative {
            color: var(--danger-color);
        }

        /* Code Blocks */
        pre {
            background-color: var(--sidebar-bg);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
            margin: 1rem 0;
        }

        code {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 24px;
            background-color: var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #60a5fa);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            transition: width 0.5s ease;
        }

        /* Recommendations */
        .recommendation {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
            border-left: 4px solid;
        }

        .recommendation.priority-high {
            background-color: #fee2e2;
            border-color: var(--danger-color);
        }

        .recommendation.priority-medium {
            background-color: #fef3c7;
            border-color: var(--warning-color);
        }

        .recommendation.priority-low {
            background-color: #dbeafe;
            border-color: var(--primary-color);
        }

        .dark-mode .recommendation.priority-high {
            background-color: #7f1d1d;
        }

        .dark-mode .recommendation.priority-medium {
            background-color: #78350f;
        }

        .dark-mode .recommendation.priority-low {
            background-color: #1e3a8a;
        }

        /* Action Items */
        .action-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            margin: 0.5rem 0;
            background-color: var(--sidebar-bg);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .action-checkbox {
            margin-top: 0.2rem;
        }

        .action-content {
            flex: 1;
        }

        .action-meta {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #6b7280;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                max-width: 100%;
            }

            .chart-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.2rem;
            }

            .search-box {
                width: 150px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }

        .icon {
            width: 20px;
            height: 20px;
            display: inline-block;
        }

        /* Trace Statistics */
        .trace-stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .trace-stat-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .trace-stat-card h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-color);
            font-weight: 600;
        }

        .chart-container-small {
            position: relative;
            height: 200px;
            margin-bottom: 1rem;
        }

        .stat-text {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-color);
            margin-top: 0.5rem;
        }

        .keywords-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            min-height: 100px;
        }

        .keyword-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .keyword-tag.danger {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .keyword-tag.warning {
            background-color: rgba(245, 158, 11, 0.1);
            border-color: var(--warning-color);
            color: var(--warning-color);
        }

        .keyword-count {
            background-color: var(--bg-color);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .no-data {
            color: var(--text-color);
            opacity: 0.6;
            font-style: italic;
            padding: 2rem;
            text-align: center;
        }

        @media (max-width: 1200px) {
            .trace-stats-container {
                grid-template-columns: 1fr;
            }
        }

        /* Print Styles */
        @media print {
            /* Hide interactive elements */
            .header, .sidebar, .filters, .btn, .modal, .nav-item, .theme-toggle {
                display: none !important;
            }

            /* Reset layout for print */
            .main-content {
                margin-left: 0 !important;
                max-width: 100% !important;
                padding: 0 !important;
            }

            .container {
                display: block !important;
            }

            /* Show ALL content sections (tabs) for print */
            .content-section {
                display: block !important;
                page-break-inside: avoid;
                margin-bottom: 2rem;
            }

            .content-section.hidden {
                display: block !important;
            }

            /* Add section titles for print clarity */
            .content-section::before {
                content: attr(id);
                display: block;
                font-size: 1.5rem;
                font-weight: bold;
                text-transform: capitalize;
                border-bottom: 2px solid #333;
                padding-bottom: 0.5rem;
                margin-bottom: 1rem;
            }

            /* Cards should not break across pages */
            .card {
                page-break-inside: avoid;
                break-inside: avoid;
                margin-bottom: 1rem;
            }

            /* Ensure tables fit on page */
            table {
                font-size: 0.85rem;
            }

            /* Charts may not render well in print - show placeholder */
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }

            /* Ensure proper page breaks between major sections */
            #executive-summary,
            #evaluation-config,
            #eval-criteria,
            #trace-matrix,
            #response-quality,
            #insights,
            #performance,
            #recommendations {
                page-break-before: auto;
            }

            /* Hide elements that don't make sense in print */
            .chart-container {
                page-break-inside: avoid;
            }

            /* Ensure text is readable */
            body {
                font-size: 12pt;
                line-height: 1.4;
                color: #000 !important;
                background: #fff !important;
            }

            /* Reset dark mode for print */
            .dark-mode {
                --text-color: #000;
                --bg-color: #fff;
                --card-bg: #fff;
                --border-color: #ccc;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background-color: var(--hover-bg);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .trace-detail-section {
            margin-bottom: 1.5rem;
        }

        .trace-detail-section h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-color);
        }

        .trace-detail-section pre {
            background-color: var(--hover-bg);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .trace-detail-section code {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }

        .trace-metadata {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .trace-metadata-item {
            display: flex;
            flex-direction: column;
        }

        .trace-metadata-item strong {
            font-size: 0.875rem;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 0.25rem;
        }

        .trace-metadata-item span {
            font-size: 1rem;
            color: var(--text-color);
        }

        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .clickable-row:hover {
            background-color: var(--hover-bg);
        }

        /* Quality Metrics Gauges */
        .gauges-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 0;
            padding: 2rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .gauge-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .gauge {
            position: relative;
            width: 140px;
            height: 140px;
        }

        .gauge svg {
            transform: rotate(-90deg);
        }

        .gauge-bg {
            fill: none;
            stroke: #e9ecef;
            stroke-width: 12;
        }

        .gauge-fill {
            fill: none;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.6s ease;
        }

        .gauge-fill.good {
            stroke: #22c55e;
        }

        .gauge-fill.fair {
            stroke: #eab308;
        }

        .gauge-fill.poor {
            stroke: #ef4444;
        }

        .gauge-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .gauge-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-color);
        }

        .gauge-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
            text-align: center;
        }

        .gauge-detail {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .gauge-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .gauge-status.good {
            background: #dcfce7;
            color: #16a34a;
        }

        .gauge-status.fair {
            background: #fef9c3;
            color: #ca8a04;
        }

        .gauge-status.poor {
            background: #fee2e2;
            color: #dc2626;
        }

        .observations {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .observations-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }

        .observations-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .observations-list li {
            font-size: 14px;
            color: #4b5563;
            padding-left: 28px;
            position: relative;
            line-height: 1.8;
        }

        .observations-list li::before {
            content: "‚úì";
            position: absolute;
            left: 0;
            width: 18px;
            height: 18px;
            background: #e5e7eb;
            color: #9ca3af;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            top: 4px;
        }

        .observations-list li.highlight {
            color: #ca8a04;
            font-weight: 500;
        }

        .observations-list li.highlight::before {
            content: "!";
            width: 18px;
            height: 18px;
            background: #f59e0b;
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            top: 4px;
        }

        /* Case Card Styles */
        .cases-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .case-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .case-card.critical {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        .case-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .case-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .case-tag {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            background: #fef3c7;
            color: #92400e;
            font-weight: 500;
        }

        .case-card.critical .case-tag {
            background: #fee2e2;
            color: #991b1b;
        }

        .case-body {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 180px;
        }

        .case-meta {
            padding: 16px 20px;
            border-right: 1px solid rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .meta-label {
            font-size: 11px;
            font-weight: 600;
            color: #78716c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meta-value {
            font-size: 13px;
            color: var(--text-color);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .metric-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 6px;
            background: var(--hover-bg);
        }

        .metric-badge.pass {
            color: #16a34a;
        }

        .metric-badge.partial {
            color: #ca8a04;
        }

        .metric-badge.fail {
            color: #dc2626;
        }

        .case-content {
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .conversation-box {
            background: var(--hover-bg);
            border-radius: 8px;
            padding: 14px 16px;
            font-size: 13px;
            line-height: 1.6;
        }

        .conv-label {
            font-size: 11px;
            font-weight: 600;
            color: #78716c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .conv-turn {
            margin-bottom: 8px;
        }

        .conv-turn:last-child {
            margin-bottom: 0;
        }

        .conv-role {
            font-weight: 600;
            color: #57534e;
        }

        .conv-role.user {
            color: #2563eb;
        }

        .conv-role.agent {
            color: #7c3aed;
        }

        .conv-text {
            color: var(--text-color);
        }

        .conv-highlight {
            background: #fef08a;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .conv-issue {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed rgba(0,0,0,0.1);
            color: #b45309;
            font-style: italic;
        }

        .recommendation-box {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            background: var(--hover-bg);
            border-radius: 8px;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
        }

        .recommendation-icon {
            font-size: 16px;
            flex-shrink: 0;
        }

        .recommendation-text {
            font-size: 13px;
            color: var(--text-color);
            line-height: 1.5;
        }

        .case-footer {
            padding: 12px 20px;
            border-top: 1px solid rgba(0,0,0,0.06);
            display: flex;
            justify-content: flex-end;
        }

        .view-trace-link {
            font-size: 13px;
            color: #0369a1;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }

        .view-trace-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 1024px) {
            .case-body {
                grid-template-columns: 1fr;
            }

            .case-meta {
                border-right: none;
                border-bottom: 1px solid rgba(0,0,0,0.06);
            }
        }

        /* Quality Improvement Cards */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 24px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 32px;
        }

        /* Pattern Card */
        .pattern-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .pattern-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 0;
            border-bottom: none;
            margin-bottom: 0;
        }

        .pattern-card .card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
            background: #f3f4f6;
        }

        .card-icon.persona {
            background: #ede9fe;
        }

        .card-icon.tokens {
            background: #fef3c7;
        }

        .card-icon.intent {
            background: #dbeafe;
        }

        .impact-badge {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 12px;
            background: #fee2e2;
            color: #991b1b;
            white-space: nowrap;
        }

        .impact-badge.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .impact-badge.low {
            background: #e5e7eb;
            color: #4b5563;
        }

        /* Context Section */
        .card-context {
            font-size: 13px;
            line-height: 1.6;
            color: #4b5563;
        }

        .context-highlight {
            color: var(--text-color);
            font-weight: 500;
        }

        /* Evidence */
        .card-evidence {
            background: var(--sidebar-bg);
            border-radius: 8px;
            padding: 12px;
            font-size: 12px;
        }

        .evidence-label {
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .evidence-list {
            color: #4b5563;
            line-height: 1.5;
        }

        .evidence-item {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .evidence-item::before {
            content: "‚Ä¢";
            color: #9ca3af;
        }

        /* Root Cause */
        .root-cause {
            font-size: 13px;
            color: #6b7280;
            padding-left: 12px;
            border-left: 2px solid var(--border-color);
        }

        .root-cause-label {
            font-size: 11px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        /* Action Box */
        .action-box {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 12px 14px;
            margin-top: auto;
        }

        .action-label {
            font-size: 11px;
            font-weight: 600;
            color: #16a34a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .action-text {
            font-size: 13px;
            color: #166534;
            line-height: 1.5;
        }

        /* Quick Wins Section */
        .quick-wins {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px 24px;
        }

        .quick-wins-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .quick-wins-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-color);
        }

        .quick-wins-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quick-win-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 13px;
            color: var(--text-color);
            cursor: pointer;
        }

        .quick-win-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            flex-shrink: 0;
            margin-top: 1px;
            cursor: pointer;
            accent-color: #22c55e;
        }

        .quick-win-item input[type="checkbox"]:checked + .quick-win-text {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .quick-win-text {
            transition: all 0.2s ease;
        }

        @media (max-width: 1024px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary, #6b7280);
            background: var(--sidebar-bg);
            border-radius: 8px;
            border: 1px dashed var(--border-color);
        }

        .empty-state-icon {
            margin-bottom: 0.5rem;
            color: var(--text-secondary, #6b7280);
        }

        .empty-state-icon svg {
            width: 32px;
            height: 32px;
            opacity: 0.6;
        }

        .empty-state-message {
            font-size: 0.875rem;
        }

        /* Dark mode adjustments for cards */
        .dark-mode .card-icon.persona {
            background: #5b21b6;
        }

        .dark-mode .card-icon.tokens {
            background: #78350f;
        }

        .dark-mode .card-icon.intent {
            background: #1e3a8a;
        }

        .dark-mode .action-box {
            background: #064e3b;
            border-color: #065f46;
        }

        .dark-mode .action-label {
            color: #86efac;
        }

        .dark-mode .action-text {
            color: #bbf7d0;
        }

        /* Failed Cases Matrix Styles */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 4px;
        }

        .section-header .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .legend-trigger {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #6b7280;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .legend-trigger:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .dark-mode .legend-trigger:hover {
            background: #4b5563;
            color: #f9fafb;
        }

        .legend-trigger .icon {
            width: 18px;
            height: 18px;
            border: 1.5px solid #9ca3af;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: #9ca3af;
        }

        .legend-trigger:hover .icon {
            border-color: #6b7280;
            color: #6b7280;
        }

        /* Trace Table */
        .trace-table-container {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .trace-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .trace-table th {
            text-align: center;
            padding: 14px 12px;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .trace-table th:first-child {
            text-align: left;
            padding-left: 24px;
            width: 120px;
        }

        .trace-table th:not(:first-child) {
            width: 80px;
        }

        .trace-table td {
            padding: 16px 12px;
            font-size: 14px;
            color: var(--text-color);
            border-bottom: 1px solid #f3f4f6;
            text-align: center;
            vertical-align: middle;
        }

        .dark-mode .trace-table td {
            border-bottom: 1px solid #374151;
        }

        .trace-table td:first-child {
            text-align: left;
            padding-left: 24px;
        }

        .trace-table tr:last-child td {
            border-bottom: none;
        }

        .trace-table tr:hover {
            background: #fafafa;
        }

        .dark-mode .trace-table tr:hover {
            background: #4b5563;
        }

        .trace-id {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            color: var(--text-color);
            font-weight: 500;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Status Icons */
        .status-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            font-size: 14px;
        }

        .status-icon.pass {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-icon.fail {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-icon.partial {
            background: #fef3c7;
            color: #d97706;
        }

        .status-icon.review {
            background: #f3f4f6;
            color: #6b7280;
        }

        .dark-mode .status-icon.pass {
            background: #166534;
            color: #dcfce7;
        }

        .dark-mode .status-icon.fail {
            background: #991b1b;
            color: #fee2e2;
        }

        .dark-mode .status-icon.partial {
            background: #92400e;
            color: #fef3c7;
        }

        .dark-mode .status-icon.review {
            background: #6b7280;
            color: #f3f4f6;
        }

        /* Overall column highlight */
        .trace-table th:nth-child(2),
        .trace-table td:nth-child(2) {
            background: #fafafa;
        }

        .dark-mode .trace-table th:nth-child(2),
        .dark-mode .trace-table td:nth-child(2) {
            background: #374151;
        }

        .trace-table tr:hover td:nth-child(2) {
            background: #f5f5f5;
        }

        .dark-mode .trace-table tr:hover td:nth-child(2) {
            background: #4b5563;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .legend-modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 28px 32px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
        }

        .modal-close {
            width: 28px;
            height: 28px;
            border: none;
            background: #f3f4f6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .dark-mode .modal-close {
            background: #4b5563;
            color: #9ca3af;
        }

        .modal-close:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .dark-mode .modal-close:hover {
            background: #6b7280;
            color: #f3f4f6;
        }

        .legend-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .legend-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            flex-shrink: 0;
        }

        .legend-icon.pass {
            background: #dcfce7;
            color: #16a34a;
        }

        .legend-icon.fail {
            background: #fee2e2;
            color: #dc2626;
        }

        .legend-icon.partial {
            background: #fef3c7;
            color: #d97706;
        }

        .legend-icon.review {
            background: #f3f4f6;
            color: #6b7280;
        }

        .dark-mode .legend-icon.pass {
            background: #166534;
            color: #dcfce7;
        }

        .dark-mode .legend-icon.fail {
            background: #991b1b;
            color: #fee2e2;
        }

        .dark-mode .legend-icon.partial {
            background: #92400e;
            color: #fef3c7;
        }

        .dark-mode .legend-icon.review {
            background: #6b7280;
            color: #f3f4f6;
        }

        .legend-content {
            flex: 1;
        }

        .legend-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 2px;
        }

        .legend-desc {
            font-size: 13px;
            color: #6b7280;
        }

        /* Info Card Styles */
        .info-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .info-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-item.horizontal {
            flex-direction: row;
            align-items: flex-start;
            gap: 12px;
        }

        .info-item.horizontal .info-label {
            min-width: 70px;
        }

        .info-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
        }

        .info-value {
            font-size: 14px;
            color: var(--text-color);
        }

        .info-item:last-child .info-value {
            font-size: 15px;
            line-height: 1.5;
        }

        /* Hero Card Styles */
        .hero-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .hero-content {
            display: flex;
            align-items: center;
            gap: 40px;
            margin-bottom: 32px;
        }

        .hero-score {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .hero-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            background: #dcfce7;
            color: #16a34a;
        }

        .hero-percent {
            font-size: 56px;
            font-weight: 700;
            color: #16a34a;
            line-height: 1;
        }

        .hero-percent-symbol {
            font-size: 0.35em;
            vertical-align: baseline;
            margin-left: 2px;
        }

        .hero-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .hero-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }

        .hero-subtitle {
            font-size: 14px;
            color: #6b7280;
        }

        /* Progress Bar */
        .progress-container {
            flex: 1;
            max-width: 400px;
        }

        .progress-bar {
            height: 12px;
            background: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #22c55e;
            border-radius: 6px;
            transition: width 0.6s ease;
        }

        .progress-label {
            font-size: 13px;
            color: #6b7280;
        }

        .progress-label strong {
            color: var(--text-color);
        }

        /* Executive Subtitle Divider */
        .executive-subtitle-divider {
            border-top: 1px dashed var(--border-color);
            padding-top: 16px;
            margin-top: 8px;
            margin-bottom: 16px;
        }

        .executive-subtitle-text {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
        }

        .dark-mode .executive-subtitle-text {
            color: #9ca3af;
        }

        /* Summary Badges */
        .summary-badges {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .summary-badge {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            background: #f9fafb;
            border-radius: 10px;
            min-width: 160px;
        }

        .summary-badge.clickable {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .summary-badge.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .badge-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
        }

        .badge-icon.marginal {
            background: #fef3c7;
            color: #d97706;
        }

        .badge-icon.failed {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge-icon.review {
            background: #e5e7eb;
            color: #6b7280;
        }

        .badge-content {
            display: flex;
            flex-direction: column;
        }

        .badge-count {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-color);
            line-height: 1.2;
        }

        .badge-label {
            font-size: 13px;
            color: #6b7280;
        }

        /* Attention Table */
        .attention-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .attention-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .attention-header-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            background: #fee2e2;
            color: #dc2626;
        }

        .attention-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-color);
        }

        .attention-count {
            font-size: 13px;
            color: #6b7280;
            background: var(--sidebar-bg);
            padding: 2px 10px;
            border-radius: 12px;
        }

        .attention-table {
            width: 100%;
            border-collapse: collapse;
        }

        .attention-table th {
            text-align: left;
            padding: 12px 20px;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .attention-table th:first-child {
            padding-left: 24px;
        }

        .attention-table td {
            padding: 16px 20px;
            font-size: 14px;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .attention-table td:first-child {
            padding-left: 24px;
        }

        .attention-table tr:last-child td {
            border-bottom: none;
        }

        .attention-table tbody tr {
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .attention-table tbody tr:hover {
            background: var(--hover-bg);
        }

        .trace-id {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            color: var(--text-color);
            font-weight: 500;
            display: inline-block;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .input-text {
            color: #4b5563;
            font-size: 13px;
            display: inline-block;
            max-width: 350px;
            word-break: break-word;
        }

        /* Status Tags */
        .status-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-tag .tag-icon {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
        }

        .status-tag.fail {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-tag.fail .tag-icon {
            background: #dc2626;
            color: white;
        }

        .status-tag.review {
            background: #f3f4f6;
            color: #4b5563;
        }

        .status-tag.review .tag-icon {
            background: #6b7280;
            color: white;
        }

        .status-tag.marginal {
            background: #fef3c7;
            color: #d97706;
        }

        .status-tag.marginal .tag-icon {
            background: #d97706;
            color: white;
        }

        .issue-text {
            font-size: 13px;
            color: #6b7280;
            min-width: 140px;
        }

        .reason-text {
            font-size: 13px;
            color: #6b7280;
            min-width: 200px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 20px;
        }

        /* Overall Assessment Cards Styles */
        .assessment-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 2rem;
        }

        /* Category Card */
        .category-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .category-card.clickable {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .category-card.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .category-header {
            padding: 14px 24px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }

        .category-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .category-status .status-icon {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
        }

        .category-status.good {
            background: #dcfce7;
            color: #16a34a;
        }

        .category-status.good .status-icon {
            background: #16a34a;
            color: white;
        }

        .category-status.fair {
            background: #fef3c7;
            color: #d97706;
        }

        .category-status.fair .status-icon {
            background: #d97706;
            color: white;
        }

        .category-status.info {
            background: #e0f2fe;
            color: #0284c7;
        }

        .category-status.info .status-icon {
            background: #0284c7;
            color: white;
        }

        .category-body {
            padding: 20px 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Metric Row */
        .metric-row {
            display: grid;
            grid-template-columns: 200px 1fr 100px 110px;
            align-items: center;
            gap: 20px;
        }

        .metric-name {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .metric-bar-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .metric-bar {
            flex: 1;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            max-width: 200px;
        }

        .metric-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.4s ease;
        }

        .metric-bar-fill.good {
            background: #22c55e;
        }

        .metric-bar-fill.fair {
            background: #eab308;
        }

        .metric-bar-fill.poor {
            background: #ef4444;
        }

        .assessment-metric-value {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .metric-detail {
            font-size: 12px;
            color: #6b7280;
        }

        .metric-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .metric-status .status-icon {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 700;
        }

        .metric-status.good {
            background: #dcfce7;
            color: #16a34a;
        }

        .metric-status.good .status-icon {
            background: #16a34a;
            color: white;
        }

        .metric-status.fair {
            background: #fef3c7;
            color: #d97706;
        }

        .metric-status.fair .status-icon {
            background: #d97706;
            color: white;
        }

        .metric-status.poor {
            background: #fee2e2;
            color: #dc2626;
        }

        .metric-status.poor .status-icon {
            background: #dc2626;
            color: white;
        }

        /* Performance metrics (different display) */
        .metric-row.performance .metric-bar-container {
            justify-content: flex-start;
        }

        .metric-stat {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .metric-stat-detail {
            font-size: 12px;
            color: #6b7280;
            margin-left: 8px;
        }

        .metric-flag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            background: #e0f2fe;
            color: #0284c7;
        }

        .metric-flag .flag-icon {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            background: #0284c7;
            color: white;
        }

        .metric-flag.warning {
            background: #fef3c7;
            color: #d97706;
        }

        .metric-flag.warning .flag-icon {
            background: #d97706;
            color: white;
        }

        /* Metric Help Icon */
        .metric-help-icon {
            width: 18px;
            height: 18px;
            border: 1.5px solid #9ca3af;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #9ca3af;
            margin-left: 6px;
            vertical-align: middle;
        }

        .metric-help-icon:hover {
            border-color: #6b7280;
            background: #f3f4f6;
            color: #374151;
        }

        .dark-mode .metric-help-icon:hover {
            background: #4b5563;
            color: #f9fafb;
        }

        /* Metric Criteria Modal */
        .metric-criteria-table {
            width: 100%;
            margin-top: 1rem;
        }

        .metric-criteria-table th {
            text-align: left;
            padding: 10px 12px;
            background: var(--sidebar-bg);
            font-weight: 600;
            font-size: 13px;
            color: #374151;
            border-bottom: 2px solid var(--border-color);
        }

        .metric-criteria-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .metric-criteria-table tr:last-child td {
            border-bottom: none;
        }

        .criteria-metric-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .criteria-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 4px;
        }

        .criteria-badge.good {
            background: #dcfce7;
            color: #16a34a;
        }

        .criteria-badge.fair {
            background: #fef3c7;
            color: #d97706;
        }

        .criteria-badge.poor {
            background: #fee2e2;
            color: #dc2626;
        }

        .criteria-badge.critical {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Performance & Efficiency Section Styles */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 20px;
        }

        /* Overview Card */
        .overview-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .overview-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 32px;
            margin-bottom: 20px;
        }

        .overview-metric {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .overview-metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            line-height: 1.2;
        }

        .overview-metric-label {
            font-size: 14px;
            color: #6b7280;
        }

        .overview-metric-flag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #d97706;
            margin-top: 4px;
        }

        .overview-cost {
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
            font-size: 14px;
            color: #6b7280;
        }

        .overview-cost strong {
            color: #1f2937;
        }

        /* Performance Card */
        .performance-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .metric-card-header {
            padding: 16px 24px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .metric-card-title {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            text-align: left;
        }

        .metric-card-body {
            padding: 24px;
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Chart Box */
        .chart-box {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-title {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .chart-visual {
            height: 100px;
            display: flex;
            align-items: flex-end;
            gap: 4px;
            margin-bottom: 8px;
        }

        .chart-bar {
            flex: 1;
            background: #3b82f6;
            border-radius: 2px 2px 0 0;
            min-height: 4px;
        }

        .chart-bar.highlight {
            background: #f59e0b;
        }

        .chart-bar.outlier {
            background: #ef4444;
        }

        .chart-axis {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #9ca3af;
        }

        /* Stats Box */
        .stats-box {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
        }

        .stats-title {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .stat-label {
            font-size: 13px;
            color: #6b7280;
        }

        .stat-value {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        /* Outliers Section */
        .outliers-section {
            margin-bottom: 24px;
        }

        .outliers-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .outliers-icon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            background: #fef3c7;
            color: #d97706;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }

        .outliers-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .outliers-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .outliers-table th {
            text-align: left;
            padding: 10px 12px;
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .outliers-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
        }

        .outliers-table tr:last-child td {
            border-bottom: none;
        }

        .trace-id {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            color: #1f2937;
            font-weight: 500;
        }

        .persona-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            background: #f3f4f6;
            color: #4b5563;
        }

        /* Recommendation Box */
        .recommendation-box {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 16px;
        }

        .recommendation-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: #22c55e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .recommendation-content {
            flex: 1;
        }

        .recommendation-title {
            font-size: 13px;
            font-weight: 600;
            color: #166534;
            margin-bottom: 4px;
        }

        .recommendation-text {
            font-size: 13px;
            color: #166534;
            line-height: 1.5;
        }

        /* Persona Gap Specific */
        .comparison-chart {
            margin-bottom: 24px;
        }

        .comparison-row {
            margin-bottom: 20px;
        }

        .comparison-label {
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .comparison-bars {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .comparison-bar-row {
            display: grid;
            grid-template-columns: 80px 1fr 100px;
            align-items: center;
            gap: 12px;
        }

        .comparison-persona {
            font-size: 12px;
            color: #6b7280;
        }

        .comparison-bar-container {
            height: 24px;
            background: #f3f4f6;
            border-radius: 4px;
            overflow: hidden;
        }

        .comparison-bar-fill {
            height: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding-left: 8px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .comparison-bar-fill.persona-a {
            background: #3b82f6;
        }

        .comparison-bar-fill.persona-b {
            background: #8b5cf6;
        }

        .comparison-bar-fill.persona-c {
            background: #10b981;
        }

        .comparison-gap {
            font-size: 12px;
            font-weight: 600;
            color: #d97706;
            text-align: right;
        }

        .interpretation-box {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .interpretation-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .interpretation-text {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.6;
        }

        /* What to Fix Next Styles */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 24px;
        }

        /* Priority Group */
        .priority-group {
            margin-bottom: 32px;
        }

        .priority-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .priority-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }

        .priority-icon.critical {
            background: #fee2e2;
            color: #dc2626;
        }

        .priority-icon.important {
            background: #fef3c7;
            color: #d97706;
        }

        .priority-icon.nice-to-have {
            background: #dcfce7;
            color: #22c55e;
        }

        .priority-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-subtitle {
            font-size: 12px;
            color: #9ca3af;
            margin-left: auto;
        }

        /* Issue Item */
        .issue-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .issue-header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }

        .issue-header:hover {
            background: #f9fafb;
        }

        .issue-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            transition: transform 0.2s;
        }

        .issue-toggle svg {
            width: 12px;
            height: 12px;
            stroke: #9ca3af;
            stroke-width: 2;
            fill: none;
        }

        .issue-item.open .issue-toggle {
            transform: rotate(90deg);
        }

        .issue-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }

        .issue-impact {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
        }

        .issue-impact-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .issue-impact-badge.fail {
            background: #fee2e2;
            color: #dc2626;
        }

        .issue-impact-badge.warn {
            background: #fef3c7;
            color: #d97706;
        }

        .issue-impact-badge.info {
            background: #e0f2fe;
            color: #0284c7;
        }

        /* Issue Body */
        .issue-body {
            display: none;
            padding: 0 20px 20px 52px;
            border-top: 1px solid #f3f4f6;
        }

        .issue-item.open .issue-body {
            display: block;
        }

        .issue-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .issue-row:last-of-type {
            border-bottom: none;
        }

        .issue-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .issue-value {
            font-size: 13px;
            color: #374151;
            line-height: 1.5;
        }

        .trace-link {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            color: #3b82f6;
            text-decoration: none;
        }

        .trace-link:hover {
            text-decoration: underline;
        }

        .trace-input {
            color: #6b7280;
            font-style: italic;
            margin-left: 8px;
        }

        /* Evidence Box */
        .evidence-box {
            background: #f9fafb;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
        }

        .evidence-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #4b5563;
            margin-bottom: 6px;
        }

        .evidence-item:last-child {
            margin-bottom: 0;
        }

        .evidence-status {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
        }

        .evidence-status.fail {
            background: #fee2e2;
            color: #dc2626;
        }

        .evidence-status.pass {
            background: #dcfce7;
            color: #22c55e;
        }

        .evidence-status.warn {
            background: #fef3c7;
            color: #d97706;
        }

        /* Fix Box */
        .fix-box {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 14px 16px;
            margin-top: 16px;
        }

        .fix-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #166534;
            margin-bottom: 10px;
        }

        .fix-icon {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            background: #22c55e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .fix-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .fix-list li {
            position: relative;
            padding-left: 16px;
            font-size: 13px;
            color: #166534;
            line-height: 1.6;
            margin-bottom: 4px;
        }

        .fix-list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 8px;
            width: 4px;
            height: 4px;
            background: #22c55e;
            border-radius: 50%;
        }

        /* Expected Impact */
        .impact-box {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #bbf7d0;
        }

        .impact-label {
            font-size: 11px;
            font-weight: 600;
            color: #166534;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .impact-text {
            font-size: 13px;
            color: #166534;
            line-height: 1.5;
        }

        /* ============================================================
           Conversation Viewer Styles
           ============================================================ */
        .conversation-viewer-section {
            padding-top: 24px;
        }
        .trace-selector-container {
            margin-bottom: 16px;
        }
        .conv-trace-select {
            width: 100%;
            max-width: 500px;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background-color: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
        }
        .conv-trace-select:hover {
            border-color: var(--primary-color);
        }
        .conv-trace-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .conv-meta-bar {
            display: flex;
            gap: 24px;
            align-items: center;
            padding: 12px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .conv-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-muted);
        }
        .conv-meta-label {
            font-weight: 500;
            color: var(--text-color);
        }
        .conv-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
        }
        .conv-status-badge.success {
            background-color: #dcfce7;
            color: #16a34a;
        }
        .conv-status-badge.failed {
            background-color: #fee2e2;
            color: #dc2626;
        }
        .dark-mode .conv-status-badge.success {
            background-color: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }
        .dark-mode .conv-status-badge.failed {
            background-color: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }
        .conv-timeline {
            /* flat scroll - no internal scrolling */
        }
        .conv-turn-divider {
            display: flex;
            align-items: center;
            margin: 24px 0 16px 0;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
        }
        .conv-turn-divider::before,
        .conv-turn-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }
        .conv-turn-divider::before {
            margin-right: 12px;
        }
        .conv-turn-divider::after {
            margin-left: 12px;
        }
        .conv-message-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        .conv-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }
        .conv-role-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        .conv-role-indicator.user {
            color: #0066cc;
        }
        .conv-role-indicator.assistant {
            color: #34c759;
        }
        .dark-mode .conv-role-indicator.user {
            color: #60a5fa;
        }
        .dark-mode .conv-role-indicator.assistant {
            color: #4ade80;
        }
        .conv-role-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .conv-role-icon.user {
            background-color: #e3f2ff;
            color: #0066cc;
        }
        .conv-role-icon.assistant {
            background-color: #e8f5e9;
            color: #34c759;
        }
        .dark-mode .conv-role-icon.user {
            background-color: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }
        .dark-mode .conv-role-icon.assistant {
            background-color: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }
        .conv-role-icon svg {
            width: 14px;
            height: 14px;
        }
        .conv-persona-tag {
            background-color: var(--sidebar-bg);
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .conv-metadata-badge {
            font-size: 11px;
            color: var(--text-muted);
            background: var(--sidebar-bg);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .conv-actions-section {
            margin-bottom: 12px;
            margin-left: 6px;
        }
        .conv-actions-header {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
        }
        .conv-actions-header:hover {
            color: var(--primary-color);
        }
        .conv-actions-icon {
            width: 14px;
            height: 14px;
        }
        .conv-toggle-icon {
            font-size: 10px;
            transition: transform 0.2s;
        }
        .conv-toggle-icon.expanded {
            transform: rotate(90deg);
        }
        .conv-actions-list {
            margin-top: 8px;
            display: none;
        }
        .conv-actions-list.show {
            display: block;
        }
        .conv-action-item {
            padding: 6px 12px;
            margin: 4px 0;
            background-color: var(--sidebar-bg);
            border-radius: 6px;
            font-size: 12px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .conv-action-item svg {
            width: 14px;
            height: 14px;
            opacity: 0.6;
        }
        .conv-message-content {
            padding: 20px 10px;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-color);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .conv-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        .conv-empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        .conv-empty-state p {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Container -->
    <div class="container">
        <!-- Sidebar Navigation -->
        <div class="sidebar" id="sidebar">
            <!-- Sidebar Header with Logo and Toggle -->
            <div class="sidebar-header">
                <span class="sidebar-logo" onclick="navigateTo('executive-summary')" style="cursor: pointer;">Fluxloop</span>
                <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
                    <i data-lucide="panel-left-close" id="toggle-icon"></i>
                </button>
            </div>

            <div class="nav-section">
                <div class="nav-item active" onclick="navigateTo('executive-summary')">
                    <i data-lucide="bar-chart" style="width: 18px; height: 18px;"></i> <span class="nav-item-text">Overview</span>
                </div>
                <div class="nav-item" onclick="navigateTo('trace-matrix')">
                    <i data-lucide="table" style="width: 18px; height: 18px;"></i> <span class="nav-item-text">Trace Matrix</span>
                </div>
            </div>

            <div class="nav-section">
                <h3>Evals & Analysis</h3>
                <div class="nav-item" onclick="navigateTo('insights')">
                    <i data-lucide="alert-triangle" style="width: 18px; height: 18px;"></i> <span class="nav-item-text">Issues & Fails</span>
                </div>
                <div class="nav-item" onclick="navigateTo('response-quality')">
                    <i data-lucide="message-square" style="width: 18px; height: 18px;"></i> <span class="nav-item-text">Response Quality</span>
                </div>
                <div class="nav-item" onclick="navigateTo('performance')">
                    <i data-lucide="gauge" style="width: 18px; height: 18px;"></i> <span class="nav-item-text">Performance</span>
                </div>
                <div class="nav-item" onclick="navigateTo('recommendations')">
                    <i data-lucide="square-check" style="width: 18px; height: 18px;"></i> <span class="nav-item-text">What to Fix</span>
                </div>
            </div>

            <div class="nav-section">
                <h3>Settings</h3>
                <div class="nav-item" onclick="navigateTo('evaluation-config')">
                    <i data-lucide="settings" style="width: 18px; height: 18px;"></i> <span class="nav-item-text">Run Config</span>
                </div>
                <div class="nav-item" onclick="navigateTo('eval-criteria')">
                    <i data-lucide="list-checks" style="width: 18px; height: 18px;"></i> <span class="nav-item-text">Eval Criteria</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Executive Summary Section -->
            <section id="executive-summary" class="content-section">
                <!-- Info Card -->
                <div class="info-card">
                    <div class="info-grid">
                        <div class="info-item horizontal">
                            <span class="info-label">Test Date</span>
                            <span class="info-value">{{ meta.test_date }}</span>
                        </div>
                        <div class="info-item horizontal">
                            <span class="info-label">Eval Goal</span>
                            <span class="info-value">{{ config.goal }}</span>
                        </div>
                    </div>
                </div>

                <!-- Hero Card -->
                <div class="hero-card">
                    <div class="hero-content">
                        <div class="hero-score">
                            <span class="hero-icon">‚úì</span>
                            <span class="hero-percent">{{ summary.pass_rate }}<span class="hero-percent-symbol">%</span></span>
                            <div class="hero-label">
                                <span class="hero-title">Production Ready</span>
                                <span class="hero-subtitle">All systems working correctly</span>
                            </div>
                        </div>

                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ summary.pass_rate }}%"></div>
                            </div>
                            <div class="progress-label"><strong>{{ summary.passed }}</strong> of {{ summary.total_traces }} traces passed</div>
                        </div>
                    </div>

                    {% if summary.executive_subtitle %}
                    <div class="executive-subtitle-divider">
                        <p class="executive-subtitle-text">{{ summary.executive_subtitle }}</p>
                    </div>
                    {% endif %}

                    <div class="summary-badges">
                        {% for badge in summary.badges %}
                        <div class="summary-badge clickable" onclick="navigateTo('{% if badge.class == 'marginal' %}response-quality{% else %}insights{% endif %}')" title="Click to view details">
                            <div class="badge-icon {{ badge.class }}">{{ badge.icon }}</div>
                            <div class="badge-content">
                                <span class="badge-count">{{ badge.count }}</span>
                                <span class="badge-label">{{ badge.label }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Attention Required Table -->
                <div class="attention-section">
                    {% if summary.attention_required %}
                    <div class="attention-header">
                        <span class="attention-header-icon">!</span>
                        <span class="attention-title">Attention Required</span>
                        <span class="attention-count">{{ summary.attention_required | length }} traces</span>
                    </div>

                    <table class="attention-table">
                        <thead>
                            <tr>
                                <th>Trace</th>
                                <th>Input</th>
                                <th>Status</th>
                                <th>Issue</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in summary.attention_required %}
                            <tr onclick="navigateToConversation('{{ item.trace_id }}')" title="Click to view conversation">
                                <td><span class="trace-id" title="{{ item.trace_id }}">{{ trace_short(item.trace_id) }}</span></td>
                                <td><span class="input-text">"{{ item.input }}"</span></td>
                                <td><span class="status-tag {{ item.status }}"><span class="tag-icon">{{ item.status_icon }}</span> {{ item.status_label }}</span></td>
                                <td><span class="issue-text">{{ item.issue }}</span></td>
                                <td><span class="reason-text">{{ item.reason }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon"><i data-lucide="party-popper"></i></div>
                        <div class="empty-state-message">All traces passed! No attention required.</div>
                    </div>
                    {% endif %}
                </div>

                <!-- Overall Assessment Cards -->
                <h2 class="section-title" style="margin-top: 3rem;">What do the numbers say?</h2>

                <div class="assessment-grid">
                    {% for category in summary.assessment %}
                    <div class="category-card clickable" onclick="navigateTo('{% if category.name == 'Response Quality' %}response-quality{% elif category.name == 'Efficiency & Performance' %}performance{% else %}insights{% endif %}')" title="Click to view details">
                        <div class="category-header">
                            <span class="category-title">{{ category.name }} <span class="metric-help-icon" onclick="event.stopPropagation(); navigateToMetricCriteria('{{ category.modal_id }}')">?</span></span>
                        </div>
                        <div class="category-body">
                            {% if category.is_performance %}
                            {# Performance metrics (Îã§Î•∏ Î†àÏù¥ÏïÑÏõÉ) #}
                            {% for row in category.performance_rows %}
                            <div class="metric-row performance">
                                <span class="metric-name">{{ row.name }}</span>
                                <div class="metric-bar-container">
                                    <span class="metric-stat">{{ row.stat }}</span>
                                    <span class="metric-stat-detail">{{ row.stat_detail }}</span>
                                </div>
                                <div></div>
                                <span class="metric-flag {{ row.flag_type }}">
                                    <span class="flag-icon">!</span>
                                    {{ row.flag_text }}
                                </span>
                            </div>
                            {% endfor %}
                            {% else %}
                            {# Standard metrics with progress bar #}
                            {% for row in category.metric_rows %}
                            <div class="metric-row">
                                <span class="metric-name">{{ row.name }}</span>
                                <div class="metric-bar-container">
                                    <div class="metric-bar">
                                        <div class="metric-bar-fill {{ row.status }}" style="width: {{ row.percent }}%"></div>
                                    </div>
                                </div>
                                <div>
                                    <span class="assessment-metric-value">{{ row.percent }}%</span>
                                    <span class="metric-detail">({{ row.passed }}/{{ row.total }})</span>
                                </div>
                                <span class="metric-status {{ row.status }}">
                                    <span class="status-icon">{{ row.status_icon }}</span>
                                    {{ row.status_label }}
                                </span>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- Evaluation Configuration -->
            <section id="evaluation-config" class="content-section hidden">
                <style>
                    #evaluation-config .section-title {
                      font-size: 18px;
                      font-weight: 600;
                      color: #1a1a1a;
                      margin-bottom: 24px;
                    }

                    /* Card */
                    #evaluation-config .run-config-card {
                      background: white;
                      border: 1px solid #e5e7eb;
                      border-radius: 12px;
                      margin-bottom: 20px;
                      overflow: hidden;
                      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                    }

                    #evaluation-config .run-config-card-header {
                      padding: 16px 24px;
                      background: #f9fafb;
                      border-bottom: 1px solid #e5e7eb;
                    }

                    #evaluation-config .run-config-card-title {
                      font-size: 14px;
                      font-weight: 600;
                      color: #1f2937;
                    }

                    #evaluation-config .run-config-card-body {
                      padding: 24px;
                    }

                    /* Goal Box */
                    #evaluation-config .goal-box {
                      background: #f0f9ff;
                      border: 1px solid #bae6fd;
                      border-radius: 8px;
                      padding: 16px 20px;
                      margin-bottom: 24px;
                    }

                    #evaluation-config .goal-label {
                      font-size: 11px;
                      font-weight: 600;
                      color: #0369a1;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      margin-bottom: 6px;
                    }

                    #evaluation-config .goal-text {
                      font-size: 14px;
                      color: #0c4a6e;
                      line-height: 1.5;
                    }

                    /* Info Grid */
                    #evaluation-config .info-grid {
                      display: grid;
                      grid-template-columns: repeat(3, 1fr);
                      gap: 24px;
                      align-items: stretch;
                    }

                    #evaluation-config .info-section {
                      padding: 16px;
                      background: #f9fafb;
                      border-radius: 8px;
                      height: 100%;
                      box-sizing: border-box;
                    }

                    #evaluation-config .info-section-title {
                      font-size: 11px;
                      font-weight: 600;
                      color: #6b7280;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      margin-bottom: 12px;
                      padding-bottom: 8px;
                      border-bottom: 1px solid #e5e7eb;
                    }

                    #evaluation-config .info-row {
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding: 6px 0;
                    }

                    #evaluation-config .info-label {
                      font-size: 13px;
                      color: #6b7280;
                    }

                    #evaluation-config .info-value {
                      font-size: 13px;
                      font-weight: 500;
                      color: #1f2937;
                    }

                    #evaluation-config .info-value.mono {
                      font-family: 'SF Mono', Monaco, monospace;
                      font-size: 12px;
                    }

                    /* Tags */
                    #evaluation-config .tag-list {
                      display: flex;
                      flex-wrap: wrap;
                      gap: 6px;
                    }

                    #evaluation-config .tag {
                      padding: 3px 8px;
                      border-radius: 4px;
                      font-size: 11px;
                      font-weight: 500;
                      background: #f3f4f6;
                      color: #4b5563;
                    }

                    #evaluation-config .tag.metric {
                      background: #ede9fe;
                      color: #7c3aed;
                    }

                    #evaluation-config .tag.strategy {
                      background: #fef3c7;
                      color: #d97706;
                    }

                    /* Persona Grid */
                    #evaluation-config .persona-grid {
                      display: grid;
                      grid-template-columns: repeat(2, 1fr);
                      gap: 20px;
                    }

                    #evaluation-config .persona-card {
                      background: #f9fafb;
                      border-radius: 8px;
                      padding: 20px;
                    }

                    #evaluation-config .persona-header {
                      display: flex;
                      align-items: center;
                      gap: 10px;
                      margin-bottom: 12px;
                    }

                    #evaluation-config .persona-icon {
                      width: 16px;
                      height: 16px;
                      border-radius: 8px;
                      background: transparent;
                      color: #1f2937;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 14px;
                    }

                    #evaluation-config .persona-name {
                      font-size: 14px;
                      font-weight: 600;
                      color: #1f2937;
                    }

                    #evaluation-config .persona-desc {
                      font-size: 13px;
                      color: #6b7280;
                      margin-bottom: 12px;
                    }

                    #evaluation-config .persona-chars {
                      list-style: none;
                      margin: 0 0 12px 0;
                      padding: 0;
                    }

                    #evaluation-config .persona-chars li {
                      font-size: 12px;
                      color: #4b5563;
                      padding: 3px 0;
                      padding-left: 14px;
                      position: relative;
                    }

                    #evaluation-config .persona-chars li::before {
                      content: '‚Ä¢';
                      position: absolute;
                      left: 0;
                      color: #9ca3af;
                    }

                    /* Base Input */
                    #evaluation-config .base-input-box {
                      background: #f9fafb;
                      border-radius: 8px;
                      padding: 16px;
                      margin-bottom: 20px;
                    }

                    #evaluation-config .base-input-label {
                      font-size: 11px;
                      font-weight: 600;
                      color: #6b7280;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      margin-bottom: 8px;
                    }

                    #evaluation-config .base-input-text {
                      font-size: 14px;
                      color: #1f2937;
                      font-style: italic;
                    }

                    /* Inputs Table */
                    #evaluation-config .inputs-table-header {
                      display: flex;
                      align-items: center;
                      justify-content: space-between;
                      margin-bottom: 12px;
                    }

                    #evaluation-config .inputs-table-title {
                      font-size: 11px;
                      font-weight: 600;
                      color: #6b7280;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                    }

                    #evaluation-config .inputs-table-count {
                      font-size: 12px;
                      color: #9ca3af;
                    }

                    #evaluation-config .inputs-table {
                      width: 100%;
                      border-collapse: collapse;
                      table-layout: fixed;
                      font-size: 13px;
                    }

                    #evaluation-config .inputs-table th {
                      text-align: left;
                      padding: 10px 12px;
                      font-size: 11px;
                      font-weight: 600;
                      color: #6b7280;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      background: #f9fafb;
                      border-bottom: 1px solid #e5e7eb;
                    }

                    #evaluation-config .inputs-table th:first-child {
                      width: 100px;
                    }

                    #evaluation-config .inputs-table th:nth-child(2) {
                      width: 90px;
                    }

                    #evaluation-config .inputs-table th:nth-child(3),
                    #evaluation-config .inputs-table td:nth-child(3) {
                      width: 100%;
                    }

                    #evaluation-config .inputs-table td {
                      padding: 12px;
                      border-bottom: 1px solid #f3f4f6;
                      color: #374151;
                      vertical-align: top;
                    }

                    #evaluation-config .inputs-table tr:last-child td {
                      border-bottom: none;
                    }

                    #evaluation-config .inputs-table .persona-badge {
                      display: inline-block;
                      padding: 2px 8px;
                      border-radius: 4px;
                      font-size: 11px;
                      font-weight: 500;
                      background: #e0e7ff;
                      color: #4f46e5;
                    }

                    #evaluation-config .inputs-table .persona-badge.expert {
                      background: #fce7f3;
                      color: #be185d;
                    }

                    #evaluation-config .inputs-table .strategy-badge {
                      display: inline-block;
                      padding: 2px 8px;
                      border-radius: 4px;
                      font-size: 11px;
                      font-weight: 500;
                      background: #fef3c7;
                      color: #d97706;
                    }

                    #evaluation-config .input-text {
                      font-size: 13px;
                      color: #374151;
                      line-height: 1.5;
                      display: block;
                      max-width: none;
                      width: 100%;
                    }

                    #evaluation-config .input-text-truncated {
                      display: -webkit-box;
                      -webkit-line-clamp: 2;
                      -webkit-box-orient: vertical;
                      overflow: hidden;
                    }
                </style>

                <!-- Overview Card -->
                <div class="run-config-card">
                    <div class="run-config-card-body">
                        <!-- Evaluation Goal -->
                        <div class="goal-box">
                            <div class="goal-label">Evaluation Goal</div>
                            <div class="goal-text">"{{ config.goal }}"</div>
                        </div>

                        <!-- Info Grid -->
                        <div class="info-grid">
                            <div class="info-section">
                                <div class="info-section-title">Test Design</div>
                                <div class="info-row">
                                    <span class="info-label">Total Traces</span>
                                    <span class="info-value">{{ config.test_design.total_traces }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Personas</span>
                                    <span class="info-value">{{ config.test_design.personas_count }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Iterations</span>
                                    <span class="info-value">{{ config.test_design.iterations }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Execution Date</span>
                                    <span class="info-value">{{ config.test_design.execution_date }}</span>
                                </div>
                            </div>

                            <div class="info-section">
                                <div class="info-section-title">Input Generation</div>
                                <div class="info-row">
                                    <span class="info-label">Base Inputs</span>
                                    <span class="info-value">{{ config.input_generation.base_inputs }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Generated</span>
                                    <span class="info-value">{{ config.input_generation.generated_count }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Generator</span>
                                    <span class="info-value mono">{{ config.input_generation.generator_model }}</span>
                                </div>
                                <div class="info-row" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                                    <span class="info-label">Strategies</span>
                                    <div class="tag-list">
                                        {% for strategy in config.input_generation.strategies %}
                                        <span class="tag strategy">{{ strategy }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <div class="info-section">
                                <div class="info-section-title">Evaluation</div>
                                <div class="info-row">
                                    <span class="info-label">Judge Model</span>
                                    <span class="info-value mono">{{ config.evaluation.judge_model }}</span>
                                </div>
                                <div class="info-row" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                                    <span class="info-label">Enabled Metrics</span>
                                    <div class="tag-list">
                                        {% for metric in config.evaluation.enabled_metrics %}
                                        <span class="tag metric">{{ metric }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Personas Card -->
                <div class="run-config-card">
                    <div class="run-config-card-header">
                        <span class="run-config-card-title">Personas</span>
                    </div>
                    <div class="run-config-card-body">
                        <div class="persona-grid">
                            {% for persona in config.personas %}
                            <div class="persona-card">
                                <div class="persona-header">
                                    <div class="persona-icon"><i data-lucide="square-user-round" style="width: 18px; height: 18px;"></i></div>
                                    <div class="persona-name">{{ persona.name }}</div>
                                </div>
                                <div class="persona-desc">{{ persona.description }}</div>
                                <ul class="persona-chars">
                                    {% for char in persona.characteristics %}
                                    <li>{{ char }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Tested Inputs Card -->
                <div class="run-config-card">
                    <div class="run-config-card-header">
                        <span class="run-config-card-title">Tested Inputs</span>
                    </div>
                    <div class="run-config-card-body">
                        <!-- Base Input -->
                        <div class="base-input-box">
                            <div class="base-input-label">Base Input</div>
                            <div class="base-input-text">"{{ config.tested_inputs.base_input }}"</div>
                        </div>

                        <!-- Generated Variations -->
                        <div class="inputs-table-header">
                            <span class="inputs-table-title">Generated Variations</span>
                            <span class="inputs-table-count">{{ config.tested_inputs.variations | length }} inputs</span>
                        </div>

                        <table class="inputs-table">
                            <thead>
                                <tr>
                                    <th>Persona</th>
                                    <th>Strategy</th>
                                    <th>Input</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for variation in config.tested_inputs.variations %}
                                <tr>
                                    <td><span class="persona-badge{% if variation.persona == 'expert' %} expert{% endif %}">{{ variation.persona }}</span></td>
                                    <td><span class="strategy-badge">{{ variation.strategy }}</span></td>
                                    <td><span class="input-text">"{{ variation.input }}"</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Eval Criteria Section -->
            <section id="eval-criteria" class="content-section hidden">
                <style>
                    #eval-criteria .section-title {
                      font-size: 18px;
                      font-weight: 600;
                      color: #1a1a1a;
                      margin-bottom: 24px;
                    }

                    /* Category Card */
                    #eval-criteria .category-card {
                      background: white;
                      border: 1px solid #e5e7eb;
                      border-radius: 12px;
                      margin-bottom: 20px;
                      overflow: hidden;
                      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                    }

                    #eval-criteria .category-header {
                      padding: 16px 24px;
                      background: #f9fafb;
                      border-bottom: 1px solid #e5e7eb;
                    }

                    #eval-criteria .category-name {
                      font-size: 14px;
                      font-weight: 600;
                      color: #1f2937;
                    }

                    #eval-criteria .category-body {
                      padding: 24px;
                    }

                    /* Overall Status Grid */
                    #eval-criteria .status-grid {
                      display: grid;
                      grid-template-columns: repeat(4, 1fr);
                      gap: 16px;
                    }

                    #eval-criteria .status-card {
                      padding: 16px;
                      border-radius: 8px;
                      text-align: center;
                    }

                    #eval-criteria .status-card.success {
                      background: #f0fdf4;
                      border: 1px solid #bbf7d0;
                    }

                    #eval-criteria .status-card.marginal {
                      background: #fef3c7;
                      border: 1px solid #fde68a;
                    }

                    #eval-criteria .status-card.failure {
                      background: #fee2e2;
                      border: 1px solid #fecaca;
                    }

                    #eval-criteria .status-card.review {
                      background: #f3f4f6;
                      border: 1px solid #e5e7eb;
                    }

                    #eval-criteria .status-icon {
                      width: 32px;
                      height: 32px;
                      border-radius: 8px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 14px;
                      font-weight: 700;
                      margin: 0 auto 10px;
                    }

                    #eval-criteria .status-card.success .status-icon {
                      background: #22c55e;
                      color: white;
                    }

                    #eval-criteria .status-card.marginal .status-icon {
                      background: #f59e0b;
                      color: white;
                    }

                    #eval-criteria .status-card.failure .status-icon {
                      background: #ef4444;
                      color: white;
                    }

                    #eval-criteria .status-card.review .status-icon {
                      background: #6b7280;
                      color: white;
                    }

                    #eval-criteria .status-name {
                      font-size: 13px;
                      font-weight: 600;
                      color: #1f2937;
                      margin-bottom: 6px;
                    }

                    #eval-criteria .status-desc {
                      font-size: 12px;
                      color: #6b7280;
                      line-height: 1.4;
                    }

                    /* Metric Item */
                    #eval-criteria .metric-item {
                      padding: 20px 0;
                      border-bottom: 1px solid #f3f4f6;
                    }

                    #eval-criteria .metric-item:last-child {
                      border-bottom: none;
                      padding-bottom: 0;
                    }

                    #eval-criteria .metric-item:first-child {
                      padding-top: 0;
                    }

                    #eval-criteria .metric-header {
                      display: flex;
                      align-items: center;
                      gap: 12px;
                      margin-bottom: 14px;
                    }

                    #eval-criteria .metric-name {
                      font-size: 14px;
                      font-weight: 600;
                      color: #1f2937;
                    }

                    #eval-criteria .metric-type {
                      padding: 3px 8px;
                      border-radius: 4px;
                      font-size: 11px;
                      font-weight: 500;
                      background: #f3f4f6;
                      color: #6b7280;
                    }

                    #eval-criteria .metric-type.llm {
                      background: #ede9fe;
                      color: #7c3aed;
                    }

                    #eval-criteria .metric-type.rule {
                      background: #e0f2fe;
                      color: #0284c7;
                    }

                    #eval-criteria .metric-type.stat {
                      background: #fef3c7;
                      color: #d97706;
                    }

                    #eval-criteria .metric-question {
                      font-size: 13px;
                      color: #6b7280;
                      font-style: italic;
                      margin-bottom: 14px;
                    }

                    #eval-criteria .metric-details {
                      display: grid;
                      grid-template-columns: 1fr 1fr;
                      gap: 16px;
                    }

                    #eval-criteria .metric-box {
                      background: #f9fafb;
                      border-radius: 6px;
                      padding: 12px 14px;
                    }

                    #eval-criteria .metric-box-title {
                      font-size: 11px;
                      font-weight: 600;
                      color: #6b7280;
                      text-transform: uppercase;
                      letter-spacing: 0.3px;
                      margin-bottom: 8px;
                    }

                    #eval-criteria .metric-box-content {
                      font-size: 12px;
                      color: #374151;
                      line-height: 1.6;
                    }

                    #eval-criteria .criteria-list {
                      list-style: none;
                      margin: 0;
                      padding: 0;
                    }

                    #eval-criteria .criteria-list li {
                      display: flex;
                      align-items: flex-start;
                      gap: 8px;
                      margin-bottom: 4px;
                    }

                    #eval-criteria .criteria-list li:last-child {
                      margin-bottom: 0;
                    }

                    #eval-criteria .criteria-label {
                      font-weight: 600;
                      white-space: nowrap;
                    }

                    /* Threshold Display */
                    #eval-criteria .threshold-row {
                      display: flex;
                      gap: 12px;
                      flex-wrap: wrap;
                    }

                    #eval-criteria .threshold-item {
                      display: flex;
                      align-items: center;
                      gap: 6px;
                      font-size: 12px;
                    }

                    #eval-criteria .threshold-icon {
                      width: 16px;
                      height: 16px;
                      border-radius: 3px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 9px;
                      font-weight: 700;
                    }

                    #eval-criteria .threshold-icon.good {
                      background: #dcfce7;
                      color: #22c55e;
                    }

                    #eval-criteria .threshold-icon.fair {
                      background: #fef3c7;
                      color: #d97706;
                    }

                    #eval-criteria .threshold-icon.poor {
                      background: #fee2e2;
                      color: #dc2626;
                    }

                    #eval-criteria .threshold-value {
                      color: #374151;
                    }

                    /* Efficiency Metrics */
                    #eval-criteria .efficiency-grid {
                      display: grid;
                      grid-template-columns: 1fr 1fr;
                      gap: 20px;
                    }

                    #eval-criteria .efficiency-item {
                      background: #f9fafb;
                      border-radius: 8px;
                      padding: 16px;
                    }

                    #eval-criteria .efficiency-header {
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      margin-bottom: 12px;
                    }

                    #eval-criteria .efficiency-name {
                      font-size: 13px;
                      font-weight: 600;
                      color: #1f2937;
                    }

                    #eval-criteria .efficiency-question {
                      font-size: 12px;
                      color: #6b7280;
                      font-style: italic;
                      margin-bottom: 12px;
                    }

                    #eval-criteria .efficiency-stats {
                      font-size: 12px;
                      color: #374151;
                      line-height: 1.6;
                    }

                    #eval-criteria .efficiency-stats code {
                      background: #e5e7eb;
                      padding: 1px 4px;
                      border-radius: 3px;
                      font-family: 'SF Mono', Monaco, monospace;
                      font-size: 11px;
                    }
                </style>

                <!-- Overall Success Classification (Hardcoded) -->
                <div class="category-card">
                    <div class="category-header">
                        <span class="category-name">Overall Success Classification</span>
                    </div>
                    <div class="category-body">
                        <div class="status-grid">
                            <div class="status-card success">
                                <div class="status-icon">‚úì</div>
                                <div class="status-name">Clear Success</div>
                                <div class="status-desc">All core functions working perfectly<br>Production ready</div>
                            </div>
                            <div class="status-card marginal">
                                <div class="status-icon">!</div>
                                <div class="status-name">Marginal Success</div>
                                <div class="status-desc">Task completed but quality/efficiency issues<br>Works but needs improvement</div>
                            </div>
                            <div class="status-card failure">
                                <div class="status-icon">‚úó</div>
                                <div class="status-name">Clear Failure</div>
                                <div class="status-desc">Core function clearly failed<br>Cannot deploy, fix required</div>
                            </div>
                            <div class="status-card review">
                                <div class="status-icon">?</div>
                                <div class="status-name">Review Needed</div>
                                <div class="status-desc">Ambiguous judgment, review required<br>Human judgment needed</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Completeness Category (Hardcoded) -->
                <div class="category-card" id="criteria-completeness">
                    <div class="category-header">
                        <span class="category-name">Completeness</span>
                    </div>
                    <div class="category-body">
                        <div class="metric-item">
                            <div class="metric-header">
                                <span class="metric-name">Task Completion Rate</span>
                                <span class="metric-type llm">LLM Judge</span>
                            </div>
                            <div class="metric-question">"Did the agent complete what was requested?"</div>
                            <div class="metric-details">
                                <div class="metric-box">
                                    <div class="metric-box-title">Criteria</div>
                                    <div class="metric-box-content">
                                        <ul class="criteria-list">
                                            <li><span class="criteria-label">PASS:</span> Fully completed</li>
                                            <li><span class="criteria-label">PARTIAL:</span> Partially completed or alternative provided</li>
                                            <li><span class="criteria-label">FAIL:</span> Not completed at all</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-box-title">Threshold</div>
                                    <div class="metric-box-content">
                                        <div class="threshold-row">
                                            <div class="threshold-item">
                                                <span class="threshold-icon good">‚úì</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.task_completion.good }} Good</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon fair">!</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.task_completion.fair }} Fair</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon poor">‚úó</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.task_completion.poor }} Poor</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Correctness Category (Hardcoded) -->
                <div class="category-card" id="criteria-correctness">
                    <div class="category-header">
                        <span class="category-name">Correctness</span>
                    </div>
                    <div class="category-body">
                        <!-- Hallucination Rate -->
                        <div class="metric-item">
                            <div class="metric-header">
                                <span class="metric-name">Hallucination Rate</span>
                                <span class="metric-type rule">Rule-based</span>
                            </div>
                            <div class="metric-question">"Is the answer correct? Is there evidence?"</div>
                            <div class="metric-details">
                                <div class="metric-box">
                                    <div class="metric-box-title">Method</div>
                                    <div class="metric-box-content">
                                        Extract specific facts from output ‚Üí Compare with timeline tool output
                                    </div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-box-title">Threshold</div>
                                    <div class="metric-box-content">
                                        <div class="threshold-row">
                                            <div class="threshold-item">
                                                <span class="threshold-icon good">‚úì</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.hallucination.good }} Good</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon fair">!</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.hallucination.fair }} Fair</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon poor">‚úó</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.hallucination.poor }} Critical</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Relevance Rate -->
                        <div class="metric-item">
                            <div class="metric-header">
                                <span class="metric-name">Relevance Rate</span>
                                <span class="metric-type llm">LLM Judge</span>
                            </div>
                            <div class="metric-question">"Is the response on-topic?"</div>
                            <div class="metric-details">
                                <div class="metric-box">
                                    <div class="metric-box-title">Criteria</div>
                                    <div class="metric-box-content">
                                        <ul class="criteria-list">
                                            <li><span class="criteria-label">PASS:</span> Directly relevant to question, minimal irrelevant info</li>
                                            <li><span class="criteria-label">FAIL:</span> Unrelated to question or contains excessive irrelevant info</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-box-title">Threshold</div>
                                    <div class="metric-box-content">
                                        <div class="threshold-row">
                                            <div class="threshold-item">
                                                <span class="threshold-icon good">‚úì</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.relevance.good }} Good</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon fair">!</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.relevance.fair }} Fair</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon poor">‚úó</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.relevance.poor }} Poor</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tool Usage Appropriateness -->
                        <div class="metric-item">
                            <div class="metric-header">
                                <span class="metric-name">Tool Usage Appropriateness</span>
                                <span class="metric-type llm">LLM Judge</span>
                            </div>
                            <div class="metric-question">"Was the task performed with appropriate process?"</div>
                            <div class="metric-details">
                                <div class="metric-box">
                                    <div class="metric-box-title">Criteria</div>
                                    <div class="metric-box-content">
                                        <ul class="criteria-list">
                                            <li><span class="criteria-label">APPROPRIATE:</span> Safe and logical process</li>
                                            <li><span class="criteria-label">INAPPROPRIATE:</span> Risky or inefficient</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-box-title">Threshold</div>
                                    <div class="metric-box-content">
                                        <div class="threshold-row">
                                            <div class="threshold-item">
                                                <span class="threshold-icon good">‚úì</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.tool_usage.good }} Good</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon fair">!</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.tool_usage.fair }} Fair</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon poor">‚úó</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.tool_usage.poor }} Poor</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quality Category (Hardcoded) -->
                <div class="category-card" id="criteria-quality">
                    <div class="category-header">
                        <span class="category-name">Quality</span>
                    </div>
                    <div class="category-body">
                        <!-- User Satisfaction -->
                        <div class="metric-item">
                            <div class="metric-header">
                                <span class="metric-name">User Satisfaction</span>
                                <span class="metric-type llm">LLM Judge</span>
                            </div>
                            <div class="metric-question">"Would a real user be satisfied?"</div>
                            <div class="metric-details">
                                <div class="metric-box">
                                    <div class="metric-box-title">Criteria</div>
                                    <div class="metric-box-content">
                                        <ul class="criteria-list">
                                            <li><span class="criteria-label">GOOD:</span> Satisfactory user experience</li>
                                            <li><span class="criteria-label">FAIR:</span> Room for improvement</li>
                                            <li><span class="criteria-label">BAD:</span> Unsatisfactory</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-box-title">Threshold</div>
                                    <div class="metric-box-content">
                                        <div class="threshold-row">
                                            <div class="threshold-item">
                                                <span class="threshold-icon good">‚úì</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.user_satisfaction.good }} Good</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon fair">!</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.user_satisfaction.fair }} Fair</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon poor">‚úó</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.user_satisfaction.poor }} Poor</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Response Clarity -->
                        <div class="metric-item">
                            <div class="metric-header">
                                <span class="metric-name">Response Clarity</span>
                                <span class="metric-type llm">LLM Judge</span>
                            </div>
                            <div class="metric-question">"Is the response clear and easy to understand?"</div>
                            <div class="metric-details">
                                <div class="metric-box">
                                    <div class="metric-box-title">Criteria</div>
                                    <div class="metric-box-content">
                                        <ul class="criteria-list">
                                            <li><span class="criteria-label">PASS:</span> Clear and structured response</li>
                                            <li><span class="criteria-label">FAIL:</span> Unclear, contradictory, duplicative, or unstructured</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-box-title">Threshold</div>
                                    <div class="metric-box-content">
                                        <div class="threshold-row">
                                            <div class="threshold-item">
                                                <span class="threshold-icon good">‚úì</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.clarity.good }} Good</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon fair">!</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.clarity.fair }} Fair</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon poor">‚úó</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.clarity.poor }} Poor</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Persona Consistency -->
                        <div class="metric-item">
                            <div class="metric-header">
                                <span class="metric-name">Persona Consistency</span>
                                <span class="metric-type llm">LLM Judge</span>
                            </div>
                            <div class="metric-question">"Did the agent respond appropriately for the user type?"</div>
                            <div class="metric-details">
                                <div class="metric-box">
                                    <div class="metric-box-title">Criteria</div>
                                    <div class="metric-box-content">
                                        <ul class="criteria-list">
                                            <li><span class="criteria-label">PASS:</span> Matches persona (tone, explanation depth)</li>
                                            <li><span class="criteria-label">FAIL:</span> Mismatches persona (e.g., jargon for novice)</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-box-title">Threshold</div>
                                    <div class="metric-box-content">
                                        <div class="threshold-row">
                                            <div class="threshold-item">
                                                <span class="threshold-icon good">‚úì</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.persona_consistency.good }} Good</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon fair">!</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.persona_consistency.fair }} Fair</span>
                                            </div>
                                            <div class="threshold-item">
                                                <span class="threshold-icon poor">‚úó</span>
                                                <span class="threshold-value">{{ eval_criteria.thresholds.persona_consistency.poor }} Poor</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Efficiency & Performance Category (Hardcoded) -->
                <div class="category-card" id="criteria-performance">
                    <div class="category-header">
                        <span class="category-name">Efficiency & Performance</span>
                    </div>
                    <div class="category-body">
                        <div class="efficiency-grid">
                            <div class="efficiency-item">
                                <div class="efficiency-header">
                                    <span class="efficiency-name">Output Tokens</span>
                                    <span class="metric-type stat">Statistical</span>
                                </div>
                                <div class="efficiency-question">"Is the response concise? Is the cost reasonable?"</div>
                                <div class="efficiency-stats">
                                    <strong>Measures:</strong> Mean, P50, P95, Std Dev, Total Cost<br>
                                    <strong>Verbose:</strong> <code>Mean + 2√óStd</code> exceeded or <code>&gt;{{ eval_criteria.efficiency_flags.verbose }}</code> tokens
                                </div>
                            </div>
                            <div class="efficiency-item">
                                <div class="efficiency-header">
                                    <span class="efficiency-name">Conversation Depth</span>
                                    <span class="metric-type stat">Statistical</span>
                                </div>
                                <div class="efficiency-question">"Are there too many unnecessary back-and-forths?"</div>
                                <div class="efficiency-stats">
                                    <strong>Measures:</strong> Mean, P50, P95, Distribution<br>
                                    <strong>Deep:</strong> <code>Mean + 2√óStd</code> exceeded or <code>&gt;{{ eval_criteria.efficiency_flags.deep }}</code> turns
                                </div>
                            </div>
                            <div class="efficiency-item">
                                <div class="efficiency-header">
                                    <span class="efficiency-name">Latency</span>
                                    <span class="metric-type stat">Statistical</span>
                                </div>
                                <div class="efficiency-question">"Is the response speed acceptable?"</div>
                                <div class="efficiency-stats">
                                    <strong>Measures:</strong> Mean, P50, P95, P99<br>
                                    <strong>Slow:</strong> <code>Mean + 2√óStd</code> exceeded or <code>&gt;{{ eval_criteria.efficiency_flags.slow }}s</code>
                                </div>
                            </div>
                            <div class="efficiency-item">
                                <div class="efficiency-header">
                                    <span class="efficiency-name">Persona Gap</span>
                                    <span class="metric-type stat">Statistical</span>
                                </div>
                                <div class="efficiency-question">"Are there efficiency differences by persona?"</div>
                                <div class="efficiency-stats">
                                    <strong>Measures:</strong> Average latency, tokens, cost per persona<br>
                                    <strong>Gap:</strong> Absolute difference, percentage ratio
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Trace Matrix Section -->
            <section id="trace-matrix" class="content-section hidden">
                <div class="card">
                    <div class="section-header" style="margin-top: 0;">
                        <h3 class="section-title">All Traces Evaluation Matrix</h3>
                        <div class="legend-trigger" onclick="openLegendModal()">
                            <span class="icon">?</span>
                            <span>What do these icons mean?</span>
                        </div>
                    </div>

                    <div class="trace-table-container">
                        <table class="trace-table">
                            <thead>
                                <tr>
                                    <th>Trace</th>
                                    <th>Overall</th>
                                    <th>Task</th>
                                    <th title="Hallucination">Halluc.</th>
                                    <th>Relevance</th>
                                    <th>Tool</th>
                                    <th title="Satisfaction">Satisf.</th>
                                    <th>Clarity</th>
                                    <th>Persona</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trace in trace_matrix.traces %}
                                <tr data-trace-id="{{ trace.id }}">
                                    <td><span class="trace-id" title="{{ trace.id }}">{{ trace_medium(trace.id) }}</span></td>
                                    {% for metric in trace.metrics %}
                                    <td><span class="status-icon {{ metric.status }}">{{ metric.icon }}</span></td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Conversation Viewer -->
                    <div class="conversation-viewer-section" style="margin-top: 48px;">
                        <div class="section-header" style="margin-top: 0;">
                            <h3 class="section-title">Conversation Detail</h3>
                        </div>

                        <!-- Trace Selector -->
                        <div class="trace-selector-container">
                            <select class="conv-trace-select" id="conversationTraceSelect">
                                <option value="">Select a trace to view conversation...</option>
                                {% for trace_id, conv in conversations.items() %}
                                <option value="{{ trace_id }}" data-trace-id="{{ trace_id }}">
                                    {{ trace_medium(trace_id) }} - {{ conv.persona }} ({{ conv.turn_count }} turns)
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Trace Meta Bar -->
                        <div class="conv-meta-bar" id="traceMetaBar" style="display: none;">
                            <span class="conv-status-badge" id="traceStatus"></span>
                            <span class="conv-meta-item"><span class="conv-meta-label">Duration:</span> <span id="traceDuration"></span></span>
                            <span class="conv-meta-item"><span class="conv-meta-label">Persona:</span> <span id="tracePersona"></span></span>
                            <span class="conv-meta-item"><span class="conv-meta-label">Turns:</span> <span id="traceTurnCount"></span></span>
                        </div>

                        <!-- Conversation Timeline -->
                        <div class="conv-timeline" id="conversationTimeline">
                            <div class="conv-empty-state">
                                <i data-lucide="message-square-text"></i>
                                <p>Select a trace above to view the conversation</p>
                            </div>
                        </div>
                    </div>

                </div>
            </section>



            <!-- Response Quality -->
            <!-- Response Quality Section -->
            <section id="response-quality" class="content-section hidden">
                <div class="card">
                    <!-- Quality Metrics Summary -->
                    <div class="section-header">
                        <h3 class="section-title">Quality Metrics Summary</h3>
                    </div>

                    <div class="gauges-container">
                        {% for metric in response_quality.quality_metrics %}
                        {{ gauge(metric) }}
                        {% endfor %}
                    </div>

                    <div class="observations">
                        <h4 class="observations-title">Key Observations</h4>
                        {% if response_quality.observations %}
                        <ul class="observations-list">
                            {% for obs in response_quality.observations %}
                            <li{% if obs.highlight %} class="highlight"{% endif %}>{{ obs.text }}</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <div class="empty-state" style="margin-top: 1rem;">
                            <div class="empty-state-icon"><i data-lucide="inbox"></i></div>
                            <div class="empty-state-message">No observations available</div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Marginal Success Cases -->
                    <div class="section-header" style="margin-top: 4rem;">
                        <h3 class="section-title">Marginal Success Cases (‚ö†Ô∏è)</h3>
                    </div>

                    {% if response_quality.marginal_cases %}
                    <div class="cases-container">
                        {% for case in response_quality.marginal_cases %}
                        <div class="case-card">
                            <div class="case-header">
                                <div class="case-title">
                                    <span>‚ö†Ô∏è</span>
                                    <code>{{ case.trace_id }}</code>
                                </div>
                                <span class="case-tag">{{ case.tag }}</span>
                            </div>

                            <div class="case-body">
                                <div class="case-meta">
                                    <div class="meta-item">
                                        <span class="meta-label">Input</span>
                                        <span class="meta-value">"{{ case.input }}"</span>
                                    </div>

                                    <div class="meta-item">
                                        <span class="meta-label">Persona</span>
                                        <span class="meta-value">{{ case.persona }}</span>
                                    </div>

                                    <div class="meta-item">
                                        <span class="meta-label">Quality</span>
                                        <div class="metrics-grid">
                                            {% for badge in case.quality_badges %}
                                            {{ metric_badge(badge) }}
                                            {% endfor %}
                                        </div>
                                    </div>

                                    {% if case.response_stats is defined %}
                                    <div class="meta-item">
                                        <span class="meta-label">Response Stats</span>
                                        <span class="meta-value" style="font-size: 12px; line-height: 1.5;">
                                            Output tokens: <strong>{{ case.response_stats.tokens }}</strong><br>
                                            ({{ case.response_stats.comparison }})
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="case-content">
                                    <div class="conversation-box">
                                        <div class="conv-label">Issue Point</div>
                                        {% for turn in case.issue_point.turns %}
                                        <div class="conv-turn">
                                            <span class="conv-role {{ turn.role }}">{{ turn.role | capitalize }}:</span>
                                            <span class="conv-text">{{ turn.text | safe }}</span>
                                        </div>
                                        {% endfor %}
                                        {% if case.issue_point.extra_content is defined %}
                                        <div style="margin-top: 8px; font-size: 12px; color: #78716c; white-space: pre-line;">{{ case.issue_point.extra_content }}</div>
                                        {% endif %}
                                        <div class="conv-issue">
                                            ‚ö† {{ case.issue_point.issue }}
                                        </div>
                                        {% if case.expected_vs_actual is defined %}
                                        <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 4px; font-size: 12px;">
                                            <strong style="color: #16a34a;">Expected (expert):</strong><br>
                                            "{{ case.expected_vs_actual.expected }}"<br><br>
                                            <strong style="color: #dc2626;">Actual (novice-style):</strong><br>
                                            {{ case.expected_vs_actual.actual }}
                                        </div>
                                        {% endif %}
                                    </div>

                                    {{ recommendation_box(case.recommendation, "üîß" if case.expected_vs_actual is defined else "üí°") }}
                                </div>
                            </div>

                            <div class="case-footer">
                                <a href="javascript:void(0)" onclick="navigateToConversation('{{ case.trace_id }}')" class="view-trace-link">
                                    View Full Trace ‚Üí
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state" style="margin-top: 2rem;">
                        <div class="empty-state-icon"><i data-lucide="party-popper"></i></div>
                        <div class="empty-state-message">No marginal cases - all passes are solid!</div>
                    </div>
                    {% endif %}

                    <!-- Quality Improvement Opportunities -->
                    <div class="section-header" style="margin-top: 2rem;">
                        <h3 class="section-title">Quality Improvement Opportunities</h3>
                    </div>

                    {% if response_quality.improvement_patterns %}
                    <div class="cards-grid">
                        {% for pattern in response_quality.improvement_patterns %}
                        <div class="pattern-card">
                            <div class="card-header">
                                <div class="card-title">
                                    <span class="card-icon {{ pattern.icon_class }}">{{ pattern.icon }}</span>
                                    {{ pattern.title }}
                                </div>
                                <span class="impact-badge{% if pattern.badge_class is defined %} {{ pattern.badge_class }}{% endif %}">{{ pattern.case_count }} case{{ 's' if pattern.case_count != 1 else '' }}</span>
                            </div>

                            <div class="card-evidence">
                                <div class="evidence-label">Evidence</div>
                                <div class="evidence-list">
                                    {% for evidence in pattern.evidence_list %}
                                    <div class="evidence-item">{{ evidence }}</div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="root-cause">
                                <div class="root-cause-label">Root Cause</div>
                                {{ pattern.root_cause }}
                            </div>

                            <div class="card-context">
                                {{ pattern.context | safe }}
                            </div>

                            <div class="action-box">
                                <div class="action-label">üí° Action</div>
                                <div class="action-text">
                                    {{ pattern.action }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state" style="margin-top: 2rem;">
                        <div class="empty-state-icon"><i data-lucide="party-popper"></i></div>
                        <div class="empty-state-message">No improvement opportunities identified!</div>
                    </div>
                    {% endif %}

                    <!-- Quick Wins -->
                    <div class="quick-wins">
                        <div class="quick-wins-header">
                            <span>üéØ</span>
                            <span class="quick-wins-title">Quick Wins</span>
                        </div>
                        {% if response_quality.quick_wins %}
                        <div class="quick-wins-list">
                            {% for win in response_quality.quick_wins %}
                            <label class="quick-win-item">
                                <input type="checkbox">
                                <span class="quick-win-text">{{ win }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon"><i data-lucide="party-popper"></i></div>
                            <div class="empty-state-message">No quick wins needed!</div>
                        </div>
                        {% endif %}
                    </div>

                </div>
            </section>

            <!-- Issues & Fails Section -->
            <section id="insights" class="content-section hidden">
                <div class="card">
                    <!-- Overview Table -->
                    <div class="section-header">
                        <h3 class="section-title">Failed & Review Cases</h3>
                        <div class="legend-trigger" onclick="openLegendModal()">
                            <span class="icon">?</span>
                            <span>What do these icons mean?</span>
                        </div>
                    </div>

                    {% if insights.table_traces %}
                    <div class="trace-table-container">
                        <table class="trace-table">
                            <thead>
                                <tr>
                                    <th>Trace</th>
                                    <th>Overall</th>
                                    <th>Task</th>
                                    <th title="Hallucination">Halluc.</th>
                                    <th>Relevance</th>
                                    <th>Tool</th>
                                    <th title="Satisfaction">Satisf.</th>
                                    <th>Clarity</th>
                                    <th>Persona</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trace in insights.table_traces %}
                                <tr onclick="document.getElementById('case-{{ trace.id }}').scrollIntoView({behavior: 'smooth', block: 'start'})" style="cursor: pointer;" title="Click to view case details">
                                    <td><span class="trace-id" title="{{ trace.id }}">{{ trace_medium(trace.id) }}</span></td>
                                    {% for metric in trace.metrics %}
                                    <td><span class="status-icon {{ metric.status }}">{{ metric.icon }}</span></td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon"><i data-lucide="party-popper"></i></div>
                        <div class="empty-state-message">All traces passed evaluation!</div>
                    </div>
                    {% endif %}

                    <!-- Failed Cases -->
                    <div class="section-header" style="margin-top: 4rem;">
                        <h3 class="section-title">Failed Cases (‚ùå)</h3>
                    </div>

                    {% if insights.failed_cases %}
                    <div class="cases-container">
                    {% for case in insights.failed_cases %}
                    <div class="case-card" id="case-{{ case.trace_id }}">
                        <div class="case-header">
                            <div class="case-title">
                                <span>‚ùå</span>
                                <code>{{ case.trace_id }}</code>
                            </div>
                            <span class="case-tag" style="background: #fef2f2; color: #991b1b; border: 1px solid #fecaca;">{{ case.tag }}</span>
                        </div>

                        <div class="case-body">
                            <div class="case-meta">
                                <div class="meta-item">
                                    <span class="meta-label">Input</span>
                                    <span class="meta-value">"{{ case.input }}"</span>
                                </div>

                                <div class="meta-item">
                                    <span class="meta-label">Persona</span>
                                    <span class="meta-value">{{ case.persona }}</span>
                                </div>

                                <div class="meta-item">
                                    <span class="meta-label">Failed Metrics</span>
                                    <div class="metrics-grid">
                                        {% for badge in case.failed_badges %}
                                        <span class="metric-badge fail">{{ badge.icon }} {{ badge.label }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <div class="case-content">
                                <div class="conversation-box">
                                    <div class="conv-label">Issue Summary</div>
                                    <p style="margin: 0.5rem 0; color: #44403c;">
                                        {{ case.issue_summary }}
                                    </p>
                                </div>

                                <div class="conversation-box">
                                    <div class="conv-label">Conversation Timeline</div>
                                    {% for turn in case.conversation_timeline %}
                                    <div class="conv-turn">
                                        <span class="conv-role {{ turn.role }}">Turn {{ turn.turn }}:</span>
                                        <span class="conv-text{% if turn.is_highlight %} conv-highlight{% endif %}">{{ turn.text | safe }}</span>
                                    </div>
                                    {% endfor %}
                                    <div class="conv-issue">
                                        ‚ùå {{ case.issue_code | safe }}
                                    </div>
                                </div>

                                <div class="conversation-box">
                                    <div class="conv-label">LLM Judge Reasoning</div>
                                    <p style="font-style: italic; color: #78716c; margin: 0.5rem 0;">
                                        "{{ case.llm_reasoning }}"
                                    </p>
                                </div>

                                <div class="conversation-box">
                                    <div class="conv-label" style="color: #dc2626;">ROOT CAUSE</div>
                                    <p style="margin: 0; color: var(--text-color);">{{ case.root_cause }}</p>
                                </div>

                                <div class="recommendation-box">
                                    <span class="recommendation-icon">üí°</span>
                                    <span class="recommendation-text">
                                        {{ case.recommendation | safe }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="case-footer">
                            <a href="javascript:void(0)" onclick="navigateToConversation('{{ case.trace_id }}')" class="view-trace-link">
                                View Full Trace ‚Üí
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state" style="margin-top: 2rem;">
                        <div class="empty-state-icon"><i data-lucide="party-popper"></i></div>
                        <div class="empty-state-message">No failed cases detected!</div>
                    </div>
                    {% endif %}

                    <!-- Review Needed Cases -->
                    <div class="section-header" style="margin-top: 4rem;">
                        <h3 class="section-title">Review Needed Cases (üîç)</h3>
                    </div>

                    {% if insights.review_cases %}
                    <div class="cases-container">
                    {% for case in insights.review_cases %}
                    <div class="case-card" id="case-{{ case.trace_id }}">
                        <div class="case-header">
                            <div class="case-title">
                                <span>üîç</span>
                                <code>{{ case.trace_id }}</code>
                            </div>
                            <span class="case-tag" style="{{ case.tag_style }}">{{ case.tag }}</span>
                        </div>

                        <div class="case-body">
                            <div class="case-meta">
                                <div class="meta-item">
                                    <span class="meta-label">Input</span>
                                    <span class="meta-value">"{{ case.input }}"</span>
                                </div>

                                <div class="meta-item">
                                    <span class="meta-label">Persona</span>
                                    <span class="meta-value">{{ case.persona }}</span>
                                </div>

                                <div class="meta-item">
                                    <span class="meta-label">Quality</span>
                                    <div class="metrics-grid">
                                        {% for badge in case.quality_badges %}
                                        {{ metric_badge(badge) }}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <div class="case-content">
                                <div class="conversation-box">
                                    <div class="conv-label">Issue Summary</div>
                                    <p style="margin: 0.5rem 0; color: #44403c;">
                                        {{ case.issue_summary }}
                                    </p>
                                </div>

                                <div class="conversation-box">
                                    <div class="conv-label">Conversation Timeline</div>
                                    {% for turn in case.conversation_timeline %}
                                    <div class="conv-turn">
                                        <span class="conv-role {{ turn.role }}">Turn {{ turn.turn }}:</span>
                                        <span class="conv-text{% if turn.is_highlight %} conv-highlight{% endif %}">{{ turn.text | safe }}</span>
                                    </div>
                                    {% endfor %}
                                    <div class="conv-issue" style="background: #fef9e7; border-left-color: #f59e0b;">
                                        üîç {{ case.issue_text }}
                                    </div>
                                </div>

                                <div class="conversation-box">
                                    <div class="conv-label">LLM Judge Reasoning</div>
                                    <p style="font-style: italic; color: #78716c; margin: 0.5rem 0;">
                                        "{{ case.llm_reasoning }}"
                                    </p>
                                </div>

                                <div style="margin-top: 1rem; padding: 0.75rem; background: #fef9e7; border-left: 3px solid #f59e0b; border-radius: 4px;">
                                    <strong style="color: #92400e;">Why Review Needed:</strong>
                                    <div style="margin-top: 0.5rem; color: #44403c;">
                                        {{ case.why_review_needed }}<br>
                                        {% for question in case.review_questions %}
                                        ‚Ä¢ {{ question }}<br>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="recommendation-box">
                                    <span class="recommendation-icon">üí°</span>
                                    <span class="recommendation-text">
                                        {{ case.recommendation }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="case-footer">
                            <a href="javascript:void(0)" onclick="navigateToConversation('{{ case.trace_id }}')" class="view-trace-link">
                                View Full Trace ‚Üí
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state" style="margin-top: 2rem;">
                        <div class="empty-state-icon"><i data-lucide="party-popper"></i></div>
                        <div class="empty-state-message">No cases require manual review!</div>
                    </div>
                    {% endif %}

                </div>
            </section>

            <!-- Performance Analysis Section -->
            <section id="performance" class="content-section hidden">
                <h2 class="section-title">Performance & Efficiency</h2>

                <!-- Overview Card -->
                <div class="overview-card">
                    <div class="overview-metrics">
                        {% for metric in performance.overview.metrics %}
                        <div class="overview-metric">
                            <span class="overview-metric-value">{{ metric.value }}</span>
                            <span class="overview-metric-label">{{ metric.label }}</span>
                            <span class="overview-metric-flag">
                                <span>{{ metric.flag_icon }}</span> {{ metric.flag_text }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="overview-cost">
                        Total Cost: <strong>{{ performance.overview.total_cost }}</strong> (avg {{ performance.overview.avg_cost_per_trace }} per trace)
                    </div>
                </div>

                <!-- Performance Cards (Output Tokens, Conversation Depth, Latency) -->
                {% for card in performance.cards %}
                <div class="performance-card">
                    <div class="metric-card-header">
                        <h3 class="metric-card-title">{{ card.title }}</h3>
                    </div>
                    <div class="metric-card-body">
                        <div class="content-grid">
                            <div class="chart-box">
                                <div class="chart-title">Distribution</div>
                                <div class="chart-visual">
                                    {% for bar in card.distribution_bars %}
                                    <div class="chart-bar{% if bar.class is defined %} {{ bar.class }}{% endif %}" style="height: {{ bar.height }}%"></div>
                                    {% endfor %}
                                </div>
                                <div class="chart-axis">
                                    {% for label in card.axis_labels %}
                                    <span>{{ label }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="stats-box">
                                <div class="stats-title">Key Statistics</div>
                                <div class="stats-grid">
                                    {% for stat in card.stats %}
                                    <div class="stat-item">
                                        <span class="stat-label">{{ stat.label }}</span>
                                        <span class="stat-value">{{ stat.value }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="outliers-section">
                            <div class="outliers-header">
                                <span class="outliers-icon">!</span>
                                <span class="outliers-title">{{ card.outliers.title }}</span>
                            </div>
                            {% if card.outliers.cases %}
                            <table class="outliers-table">
                                <thead>
                                    <tr>
                                        <th>Trace</th>
                                        <th>{{ card.outliers.value_column }}</th>
                                        <th>Persona</th>
                                        <th>Issue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for case in card.outliers.cases %}
                                    <tr>
                                        <td><span class="trace-id" title="{{ case.trace_id }}">{{ trace_medium(case.trace_id) }}</span></td>
                                        <td>{{ case.value }}</td>
                                        <td><span class="persona-badge">{{ case.persona }}</span></td>
                                        <td>{{ case.issue }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <div class="empty-state">
                                <div class="empty-state-icon"><i data-lucide="party-popper"></i></div>
                                <div class="empty-state-message">No outliers detected!</div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="recommendation-box">
                            <span class="recommendation-icon">üí°</span>
                            <div class="recommendation-content">
                                <div class="recommendation-title">Recommendation</div>
                                <div class="recommendation-text">
                                    {{ card.recommendation }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Persona Gap Card -->
                <div class="performance-card">
                    <div class="metric-card-header">
                        <h3 class="metric-card-title">Persona Performance Gap</h3>
                    </div>
                    <div class="metric-card-body">
                        <div class="comparison-chart">
                            {% for comp in performance.persona_gap.comparisons %}
                            <div class="comparison-row">
                                <div class="comparison-label">{{ comp.label }}</div>
                                <div class="comparison-bars">
                                    {% for persona_value in comp.bars %}
                                    <div class="comparison-bar-row">
                                        <span class="comparison-persona">{{ persona_value.label }}</span>
                                        <div class="comparison-bar-container">
                                            <div class="comparison-bar-fill {{ persona_value.class }}" style="width: {{ persona_value.width }}%">{{ persona_value.value }}</div>
                                        </div>
                                        {% if loop.last %}
                                        <span class="comparison-gap">{{ comp.gap }}</span>
                                        {% else %}
                                        <span class="comparison-gap"></span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="interpretation-box">
                            <div class="interpretation-title">Interpretation</div>
                            <div class="interpretation-text">
                                {{ performance.persona_gap.interpretation | safe }}
                            </div>
                        </div>

                        <div class="recommendation-box">
                            <span class="recommendation-icon">üí°</span>
                            <div class="recommendation-content">
                                <div class="recommendation-title">Optimization Opportunities</div>
                                <div class="recommendation-text">
                                    {% for rec in performance.persona_gap.recommendations %}
                                    {{ loop.index }}. {{ rec }}<br>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recommendations -->
            <section id="recommendations" class="content-section hidden">
                <div class="card">
                    {% for group in recommendations.priority_groups %}
                    <!-- {{ group.title }} -->
                    <div class="priority-group">
                        <div class="priority-header">
                            <span class="priority-icon {{ group.priority }}">{{ group.icon }}</span>
                            <span class="priority-title">{{ group.title }}</span>
                            <span class="priority-subtitle">{{ group.subtitle }}</span>
                        </div>

                        {% if group.issue_list %}
                        {% for issue in group.issue_list %}
                        <div class="issue-item {{ group.priority }}{% if issue.is_open %} open{% endif %}">
                            <div class="issue-header" onclick="toggleIssue(this)">
                                <span class="issue-toggle"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg></span>
                                <span class="issue-title">{{ issue.title }}</span>
                                <div class="issue-impact">
                                    <span class="issue-impact-badge {{ issue.impact_badge.class }}">{{ issue.impact_badge.text }}</span>
                                </div>
                            </div>
                            <div class="issue-body">
                                <div class="issue-row">
                                    <span class="issue-label">Problem</span>
                                    <span class="issue-value">{{ issue.problem }}</span>
                                </div>
                                <div class="issue-row">
                                    <span class="issue-label">Trace</span>
                                    <span class="issue-value">
                                        <a href="#" class="trace-link" title="{{ issue.trace.id }}">{{ trace_medium(issue.trace.id) }}</a>
                                        <span class="trace-input">{{ issue.trace.input }}</span>
                                    </span>
                                </div>
                                <div class="issue-row">
                                    <span class="issue-label">Root Cause</span>
                                    <span class="issue-value">{{ issue.root_cause | safe }}</span>
                                </div>
                                <div class="issue-row">
                                    <span class="issue-label">Evidence</span>
                                    <div class="issue-value">
                                        <div class="evidence-box">
                                            {% for ev in issue.evidence %}
                                            <div class="evidence-item">
                                                <span class="evidence-status {{ ev.status }}">{{ ev.icon }}</span>
                                                <span>{{ ev.text }}</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <div class="fix-box">
                                    <div class="fix-title">
                                        <span class="fix-icon">üí°</span>
                                        Recommended Fix
                                    </div>
                                    <ul class="fix-list">
                                        {% for step in issue.fix_steps %}
                                        <li>{{ step }}</li>
                                        {% endfor %}
                                    </ul>
                                    <div class="impact-box">
                                        <span class="impact-label">Expected Impact</span>
                                        <span class="impact-text">{{ issue.expected_impact }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="empty-state" style="margin-top: 1rem;">
                            <div class="empty-state-icon"><i data-lucide="party-popper"></i></div>
                            <div class="empty-state-message">No issues at this priority level!</div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </section>

        </div>
    </div>

    <script>
        // Sidebar Toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleIcon = document.getElementById('toggle-icon');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('sidebar-collapsed');

            // Change icon
            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.setAttribute('data-lucide', 'panel-left-open');
            } else {
                toggleIcon.setAttribute('data-lucide', 'panel-left-close');
            }
            lucide.createIcons();
        }

        // Navigation
        function navigateTo(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Show target section
            document.getElementById(sectionId).classList.remove('hidden');

            // Update nav items - find the correct nav item by data or onclick attribute
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                // Check if this nav item corresponds to the target section
                const onclickAttr = item.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`'${sectionId}'`)) {
                    item.classList.add('active');
                }
            });

            // Scroll to top
            window.scrollTo(0, 0);
        }


        // Collapsible
        function toggleCollapsible(element) {
            const content = element.nextElementSibling;
            const chevron = element.querySelector('.chevron');

            content.classList.toggle('active');
            chevron.classList.toggle('active');
        }

        // Toggle Issue (for What to Fix Next)
        function toggleIssue(header) {
            const item = header.closest('.issue-item');
            item.classList.toggle('open');
        }


        // Filter Traces
        function filterTraces() {
            const personaFilter = document.getElementById('personaFilter').value;
            const iterationFilter = document.getElementById('iterationFilter').value;
            const performanceFilter = document.getElementById('performanceFilter').value;
            
            const rows = document.querySelectorAll('#traceTableBody tr');
            
            rows.forEach(row => {
                let show = true;
                
                if (personaFilter !== 'all') {
                    const persona = row.getAttribute('data-persona');
                    if (persona !== personaFilter) show = false;
                }
                
                if (iterationFilter !== 'all') {
                    const iteration = row.getAttribute('data-iteration');
                    if (iteration !== iterationFilter) show = false;
                }
                
                if (performanceFilter !== 'all') {
                    const duration = parseFloat(row.getAttribute('data-duration'));
                    if (performanceFilter === 'fast' && duration >= 2000) show = false;
                    if (performanceFilter === 'slow' && duration < 2000) show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }

        // Sort Table
        function sortTable(columnIndex) {
            const table = document.getElementById('traceTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent;
                const bValue = b.cells[columnIndex].textContent;
                
                if (!isNaN(parseFloat(aValue))) {
                    return parseFloat(aValue) - parseFloat(bValue);
                }
                return aValue.localeCompare(bValue);
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }


        // Charts
        function initCharts() {
            // Response Time Chart
            const responseTimeCtx = document.getElementById('responseTimeChart');
            if (responseTimeCtx) {
                // Define persona for each trace (expert, novice, expert, novice, ...)
                const personas = ['expert', 'novice', 'expert', 'novice', 'expert', 'novice', 'expert', 'novice', 'expert', 'novice'];

                new Chart(responseTimeCtx, {
                    type: 'bar',
                    data: {
                        labels: ['9fa37469', 'cedb1f2e', 'f2ae7b72', 'df68f349', '00532387', 'c9d4fc69', '2c3e6fa8', 'd825622b', '6444e85c', '99d74978'],
                        datasets: [{
                            label: 'Response Time',
                            data: [2309.07, 1390.22, 1870.41, 2566.17, 1477.80, 3921.99, 1699.05, 1670.95, 1403.27, 1368.02],
                            backgroundColor: function(context) {
                                const index = context.dataIndex;
                                return personas[index] === 'expert' ? 'rgba(37, 99, 235, 0.6)' : 'rgba(245, 158, 11, 0.6)';
                            },
                            borderColor: function(context) {
                                const index = context.dataIndex;
                                return personas[index] === 'expert' ? 'rgba(37, 99, 235, 1)' : 'rgba(245, 158, 11, 1)';
                            },
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    generateLabels: function() {
                                        return [
                                            {
                                                text: 'Expert User',
                                                fillStyle: 'rgba(37, 99, 235, 0.6)',
                                                strokeStyle: 'rgba(37, 99, 235, 1)',
                                                lineWidth: 2
                                            },
                                            {
                                                text: 'Novice User',
                                                fillStyle: 'rgba(245, 158, 11, 0.6)',
                                                strokeStyle: 'rgba(245, 158, 11, 1)',
                                                lineWidth: 2
                                            }
                                        ];
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    thresholdLine: {
                                        type: 'line',
                                        yMin: 2000,
                                        yMax: 2000,
                                        borderColor: 'rgb(255, 99, 132)',
                                        borderWidth: 2,
                                        borderDash: [5, 5],
                                        label: {
                                            content: 'Threshold: 2000ms',
                                            enabled: true,
                                            position: 'end'
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Duration (ms)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Trace ID'
                                }
                            }
                        }
                    }
                });
            }

            // Iteration Chart
            const iterationCtx = document.getElementById('iterationChart');
            if (iterationCtx) {
                new Chart(iterationCtx, {
                    type: 'line',
                    data: {
                        labels: ['Iteration 0', 'Iteration 1', 'Iteration 2', 'Iteration 3', 'Iteration 4'],
                        datasets: [{
                            label: 'Expert User',
                            data: [2309.07, 1870.41, 1477.80, 1699.05, 1403.27],
                            borderColor: 'rgba(37, 99, 235, 1)',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Novice User',
                            data: [1390.22, 2566.17, 3921.99, 1670.95, 1368.02],
                            borderColor: 'rgba(245, 158, 11, 1)',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Duration (ms)'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Initialize Trace Statistics
        function initTraceStatistics() {
            // Collect trace data from table
            const rows = document.querySelectorAll('#traceTableBody tr');
            let successCount = 0;
            let failureCount = 0;
            const issuesMap = new Map();
            const failureCausesMap = new Map();

            rows.forEach(row => {
                // Check status (column 6)
                const statusCell = row.cells[6];
                const isSuccess = statusCell.textContent.includes('‚úÖ');

                if (isSuccess) {
                    successCount++;
                } else {
                    failureCount++;
                    // Extract failure cause from output summary or issues
                    const outputSummary = row.cells[4].textContent;
                    const issuesText = row.cells[7].textContent;

                    // Parse failure causes
                    if (issuesText && issuesText.trim() !== '') {
                        const causes = issuesText.split(',').map(c => c.trim());
                        causes.forEach(cause => {
                            if (cause) {
                                failureCausesMap.set(cause, (failureCausesMap.get(cause) || 0) + 1);
                            }
                        });
                    }
                }

                // Extract issues from Issues column (column 7)
                const issuesCell = row.cells[7];
                const issuesText = issuesCell.textContent.trim();

                if (issuesText && issuesText !== '') {
                    // Split by comma to handle multiple issues
                    const issues = issuesText.split(',').map(i => i.trim());
                    issues.forEach(issue => {
                        if (issue) {
                            issuesMap.set(issue, (issuesMap.get(issue) || 0) + 1);
                        }
                    });
                }
            });

            const totalCount = successCount + failureCount;
            const successRate = totalCount > 0 ? (successCount / totalCount * 100).toFixed(1) : 0;

            // Create Success Rate Chart
            const successRateCtx = document.getElementById('successRateChart');
            if (successRateCtx) {
                new Chart(successRateCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Success', 'Failure'],
                        datasets: [{
                            data: [successCount, failureCount],
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.6)',
                                'rgba(239, 68, 68, 0.6)'
                            ],
                            borderColor: [
                                'rgba(16, 185, 129, 1)',
                                'rgba(239, 68, 68, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const value = data.datasets[0].data[i];
                                                const percentage = totalCount > 0 ? (value / totalCount * 100).toFixed(1) : 0;
                                                return {
                                                    text: `${label}: ${value} (${percentage}%)`,
                                                    fillStyle: data.datasets[0].backgroundColor[i],
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Update success rate text
            const successRateText = document.getElementById('successRateText');
            if (successRateText) {
                successRateText.innerHTML = `<strong>${successRate}%</strong> success rate (${successCount}/${totalCount} traces)`;
            }

            // Populate Failure Causes
            const failureCausesContainer = document.getElementById('failureCauses');
            if (failureCausesContainer) {
                if (failureCausesMap.size > 0) {
                    failureCausesContainer.innerHTML = '';
                    const sortedCauses = Array.from(failureCausesMap.entries())
                        .sort((a, b) => b[1] - a[1]);

                    sortedCauses.forEach(([cause, count]) => {
                        const tag = document.createElement('div');
                        tag.className = 'keyword-tag danger';
                        tag.innerHTML = `
                            ${cause}
                            <span class="keyword-count">${count}</span>
                        `;
                        failureCausesContainer.appendChild(tag);
                    });
                } else {
                    failureCausesContainer.innerHTML = '<p class="no-data">No failures detected</p>';
                }
            }

            // Populate Detected Issues
            const detectedIssuesContainer = document.getElementById('detectedIssues');
            if (detectedIssuesContainer) {
                if (issuesMap.size > 0) {
                    detectedIssuesContainer.innerHTML = '';
                    const sortedIssues = Array.from(issuesMap.entries())
                        .sort((a, b) => b[1] - a[1]);

                    sortedIssues.forEach(([issue, count]) => {
                        const tag = document.createElement('div');
                        tag.className = 'keyword-tag warning';
                        tag.innerHTML = `
                            ${issue}
                            <span class="keyword-count">${count}</span>
                        `;
                        detectedIssuesContainer.appendChild(tag);
                    });
                } else {
                    detectedIssuesContainer.innerHTML = '<p class="no-data">No issues detected</p>';
                }
            }
        }

        // Trace Modal Functions - Embedded Data
        const embeddedTraceData = {
            "9fa37469": {
                "summary": {
                    "Trace ID": "9fa37469-10d8-471d-b495-8b716829775b",
                    "Iteration": "0",
                    "Persona": "expert_user",
                    "Duration": "2309.07 ms",
                    "Success": "True"
                },
                "input": "{\n  \"input\": \"I need to initiate a refund process for my recent transaction.\"\n}",
                "output": "{\n  \"output\": \"Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to initiate a refund for your recent transaction. Could you please specify which trip or segment you'd like to cancel for the refund?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to initiate a refund for your recent transaction. Could you please specify which trip or segment you'd like to cancel for the refund?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to initiate a refund for your recent transaction. Could you please specify which trip or segment you'd like to cancel for the refund?\"\n}"
            },
            "cedb1f2e": {
                "summary": {
                    "Trace ID": "cedb1f2e-3ffc-4788-a0c6-1a9be8a32c95",
                    "Iteration": "0",
                    "Persona": "novice_user",
                    "Duration": "1390.22 ms",
                    "Success": "True"
                },
                "input": "{\n  \"input\": \"Can you help me with getting my money back for a purchase?\"\n}",
                "output": "{\n  \"output\": \"Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I can assist you with a refund if it pertains to your upcoming trip cancellation. Could you please confirm if you'd like to cancel your upcoming reservation to proceed with the refund?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I can assist you with a refund if it pertains to your upcoming trip cancellation. Could you please confirm if you'd like to cancel your upcoming reservation to proceed with the refund?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I can assist you with a refund if it pertains to your upcoming trip cancellation. Could you please confirm if you'd like to cancel your upcoming reservation to proceed with the refund?\"\n}"
            },
            "df68f349": {
                "summary": {
                    "Trace ID": "df68f349-daf8-439b-b8b5-8638aafb9af5",
                    "Iteration": "1",
                    "Persona": "novice_user",
                    "Duration": "2566.17 ms",
                    "Success": "True"
                },
                "input": "{\n  \"input\": \"Can you help me with getting my money back for a purchase?\"\n}",
                "output": "{\n  \"output\": \"Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I'd be happy to assist you with your refund request. Could you please specify which purchase or booking you would like to get a refund for?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I'd be happy to assist you with your refund request. Could you please specify which purchase or booking you would like to get a refund for?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I'd be happy to assist you with your refund request. Could you please specify which purchase or booking you would like to get a refund for?\"\n}"
            },
            "f2ae7b72": {
                "summary": {
                    "Trace ID": "f2ae7b72-9056-434b-9808-1f7c51eb4e68",
                    "Iteration": "1",
                    "Persona": "expert_user",
                    "Duration": "1870.41 ms",
                    "Success": "True"
                },
                "input": "{\n  \"input\": \"I need to initiate a refund process for my recent transaction.\"\n}",
                "output": "{\n  \"output\": \"Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to initiate a refund for your recent transaction. To assist you properly, could you please specify which booking or transaction you'd like to have refunded?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to initiate a refund for your recent transaction. To assist you properly, could you please specify which booking or transaction you'd like to have refunded?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to initiate a refund for your recent transaction. To assist you properly, could you please specify which booking or transaction you'd like to have refunded?\"\n}"
            },
            "00532387": {
                "summary": {
                    "Trace ID": "00532387-85de-46af-bd99-c3c5291a49dc",
                    "Iteration": "2",
                    "Persona": "expert_user",
                    "Duration": "1477.80 ms",
                    "Success": "True"
                },
                "input": "{\n  \"input\": \"I need to initiate a refund process for my recent transaction.\"\n}",
                "output": "{\n  \"output\": \"Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to initiate a refund for your recent transaction. Could you please specify which trip or service you would like to have refunded? This will help me assist you promptly.Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to initiate a refund for your recent transaction. Could you please specify which trip or service you would like to have refunded? This will help me assist you promptly.Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to initiate a refund for your recent transaction. Could you please specify which trip or service you would like to have refunded? This will help me assist you promptly.\"\n}"
            },
            "c9d4fc69": {
                "summary": {
                    "Trace ID": "c9d4fc69-8278-47e1-81b6-a6602bba1092",
                    "Iteration": "2",
                    "Persona": "novice_user",
                    "Duration": "3921.99 ms",
                    "Success": "True"
                },
                "input": "{\n  \"input\": \"Can you help me with getting my money back for a purchase?\"\n}",
                "output": "{\n  \"output\": \"Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I'd be happy to assist you with your refund request. Could you please specify which purchase or booking you would like to get a refund for?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I'd be happy to assist you with your refund request. Could you please specify which purchase or booking you would like to get a refund for?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I'd be happy to assist you with your refund request. Could you please specify which purchase or booking you would like to get a refund for?\"\n}"
            },
            "2c3e6fa8": {
                "summary": {
                    "Trace ID": "2c3e6fa8-aeb0-4faf-9f68-e36b1f366398",
                    "Iteration": "3",
                    "Persona": "expert_user",
                    "Duration": "1699.05 ms",
                    "Success": "True"
                },
                "input": "{\n  \"input\": \"I need to initiate a refund process for my recent transaction.\"\n}",
                "output": "{\n  \"output\": \"Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to initiate a refund for your recent transaction. Could you please specify which booking or segment you want to refund, or if you want to cancel your upcoming trip for a refund?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to initiate a refund for your recent transaction. Could you please specify which booking or segment you want to refund, or if you want to cancel your upcoming trip for a refund?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to initiate a refund for your recent transaction. Could you please specify which booking or segment you want to refund, or if you want to cancel your upcoming trip for a refund?\"\n}"
            },
            "d825622b": {
                "summary": {
                    "Trace ID": "d825622b-6ead-4a95-a5c6-d8be6b452715",
                    "Iteration": "3",
                    "Persona": "novice_user",
                    "Duration": "1670.95 ms",
                    "Success": "True"
                },
                "input": "{\n  \"input\": \"Can you help me with getting my money back for a purchase?\"\n}",
                "output": "{\n  \"output\": \"Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I can assist you with a refund if it concerns canceling your upcoming trip. Could you please specify which purchase you want a refund for? If it's related to your flight reservation, I can proceed with the cancellation and refund process.Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I can assist you with a refund if it concerns canceling your upcoming trip. Could you please specify which purchase you want a refund for? If it's related to your flight reservation, I can proceed with the cancellation and refund process.Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I can assist you with a refund if it concerns canceling your upcoming trip. Could you please specify which purchase you want a refund for? If it's related to your flight reservation, I can proceed with the cancellation and refund process.\"\n}"
            },
            "6444e85c": {
                "summary": {
                    "Trace ID": "6444e85c-887a-48bd-b750-73d71dc32878",
                    "Iteration": "4",
                    "Persona": "expert_user",
                    "Duration": "1403.27 ms",
                    "Success": "True"
                },
                "input": "{\n  \"input\": \"I need to initiate a refund process for my recent transaction.\"\n}",
                "output": "{\n  \"output\": \"Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you'd like to initiate a refund process for your recent transaction. Could you please specify which booking or transaction you'd like to refund, or if it's related to your upcoming trips? This will help me assist you promptly.Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you'd like to initiate a refund process for your recent transaction. Could you please specify which booking or transaction you'd like to refund, or if it's related to your upcoming trips? This will help me assist you promptly.Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you'd like to initiate a refund process for your recent transaction. Could you please specify which booking or transaction you'd like to refund, or if it's related to your upcoming trips? This will help me assist you promptly.\"\n}"
            },
            "99d74978": {
                "summary": {
                    "Trace ID": "99d74978-4359-4904-898d-a85632d8525f",
                    "Iteration": "4",
                    "Persona": "novice_user",
                    "Duration": "1368.02 ms",
                    "Success": "True"
                },
                "input": "{\n  \"input\": \"Can you help me with getting my money back for a purchase?\"\n}",
                "output": "{\n  \"output\": \"Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to get a refund for a purchase. Could you please specify which purchase or booking you are referring to so I can assist you further?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to get a refund for a purchase. Could you please specify which purchase or booking you are referring to so I can assist you further?Hello Jordan, thank you for being an Aviator Platinum member with OpenSkies. I understand you want to get a refund for a purchase. Could you please specify which purchase or booking you are referring to so I can assist you further?\"\n}"
            }
        };

        function openTraceModal(traceShortId) {
            const modal = document.getElementById('traceModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTraceId');

            const traceData = embeddedTraceData[traceShortId];
            if (!traceData) {
                modalBody.innerHTML = '<p>Trace data not found.</p>';
                modal.classList.add('show');
                return;
            }

            modalTitle.textContent = `Trace Details - ${traceShortId}`;
            modal.classList.add('show');

            // Display the data directly from embedded data
            const summary = traceData.summary;
            const input = traceData.input;
            const output = traceData.output;

            let html = '<div class="trace-metadata">';
            html += `<div class="trace-metadata-item"><strong>Trace ID</strong><span>${summary['Trace ID'] || 'N/A'}</span></div>`;
            html += `<div class="trace-metadata-item"><strong>Iteration</strong><span>${summary['Iteration'] || 'N/A'}</span></div>`;
            html += `<div class="trace-metadata-item"><strong>Persona</strong><span>${summary['Persona'] || 'N/A'}</span></div>`;
            html += `<div class="trace-metadata-item"><strong>Duration</strong><span>${summary['Duration'] || 'N/A'}</span></div>`;
            html += `<div class="trace-metadata-item"><strong>Success</strong><span>${summary['Success'] || 'N/A'}</span></div>`;
            html += '</div>';

            if (input && input.trim()) {
                const parsedInput = parseTraceContent(input);
                html += '<div class="trace-detail-section">';
                html += '<h3>Input</h3>';
                html += '<pre><code>' + escapeHtml(parsedInput) + '</code></pre>';
                html += '</div>';
            }

            if (output && output.trim()) {
                const parsedOutput = parseTraceContent(output);
                html += '<div class="trace-detail-section">';
                html += '<h3>Output</h3>';
                html += '<pre><code>' + escapeHtml(parsedOutput) + '</code></pre>';
                html += '</div>';
            }

            modalBody.innerHTML = html;
        }

        function parseTraceContent(jsonString) {
            try {
                // Parse JSON
                const parsed = JSON.parse(jsonString);

                // Extract the actual content (input or output field)
                let content = parsed.input || parsed.output || jsonString;

                // Detect and format repeated text (common in outputs)
                // Check if the text appears to be repeated by looking for patterns
                content = formatRepeatedText(content);

                // Return the clean content
                return content;
            } catch (e) {
                // If parsing fails, return original string
                return jsonString;
            }
        }

        function formatRepeatedText(text) {
            // Try to detect if text is repeated multiple times
            // Common pattern: same sentence repeated 3 times without line breaks

            // Split by common sentence endings
            const sentences = text.match(/[^.!?]+[.!?]+/g);

            if (!sentences || sentences.length < 2) {
                return text;
            }

            // Check if we have repeated sentences
            const trimmedSentences = sentences.map(s => s.trim());
            const uniqueSentences = [...new Set(trimmedSentences)];

            // If we have far fewer unique sentences than total, likely repetition
            if (uniqueSentences.length < trimmedSentences.length / 2) {
                // Add line breaks between repeated sections
                let result = '';
                let lastSentence = '';
                for (const sentence of trimmedSentences) {
                    if (sentence === lastSentence) {
                        result += '\n\n' + sentence;
                    } else {
                        result += (result ? ' ' : '') + sentence;
                    }
                    lastSentence = sentence;
                }
                return result.trim();
            }

            // If no clear repetition pattern, just return formatted text
            return text;
        }

        function closeTraceModal() {
            const modal = document.getElementById('traceModal');
            modal.classList.remove('show');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('traceModal');
            if (event.target === modal) {
                closeTraceModal();
            }
        });

        // Initialize charts when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            initTraceStatistics();
            // Initialize Lucide icons
            lucide.createIcons();

            // Add click handlers for metric cards
            document.querySelectorAll('.metric-card[data-navigate]').forEach(card => {
                card.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-navigate');
                    navigateTo(targetSection);
                });
            });

            // Add click handlers for trace table rows
            const traceTableBody = document.getElementById('traceTableBody');
            if (traceTableBody) {
                traceTableBody.querySelectorAll('tr').forEach(row => {
                    row.classList.add('clickable-row');
                    row.addEventListener('click', function() {
                        const traceId = this.cells[0].textContent.trim();
                        openTraceModal(traceId);
                    });
                });
            }

            // Initialize conversation viewer
            initConversationViewer();
        });

        // ============================================================
        // Conversation Viewer
        // ============================================================
        const conversationsData = {{ conversations | tojson }};

        function initConversationViewer() {
            const select = document.getElementById('conversationTraceSelect');
            if (select) {
                select.addEventListener('change', (e) => {
                    const traceId = e.target.value;
                    if (traceId) {
                        renderConversation(traceId);
                    } else {
                        resetConversationViewer();
                    }
                });

                // Auto-load first trace
                const firstOption = select.querySelector('option[value]:not([value=""])');
                if (firstOption) {
                    select.value = firstOption.value;
                    renderConversation(firstOption.value);
                }
            }

            // Add click handlers for trace matrix rows
            const traceMatrixTable = document.querySelector('#trace-matrix .trace-table tbody');
            if (traceMatrixTable) {
                traceMatrixTable.querySelectorAll('tr[data-trace-id]').forEach(row => {
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', function() {
                        const traceId = this.getAttribute('data-trace-id');
                        selectConversationTrace(traceId);
                    });
                });
            }
        }

        function selectConversationTrace(traceId) {
            const select = document.getElementById('conversationTraceSelect');
            if (select) {
                select.value = traceId;
                renderConversation(traceId);
                // Scroll to conversation viewer
                const viewer = document.querySelector('.conversation-viewer-section');
                if (viewer) {
                    viewer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        function navigateToConversation(traceId) {
            // Navigate to trace-matrix section first
            navigateTo('trace-matrix');
            // Then select and show the conversation after a brief delay for section transition
            setTimeout(() => {
                selectConversationTrace(traceId);
            }, 100);
        }

        function resetConversationViewer() {
            document.getElementById('traceMetaBar').style.display = 'none';
            document.getElementById('conversationTimeline').innerHTML = `
                <div class="conv-empty-state">
                    <i data-lucide="message-square-text"></i>
                    <p>Select a trace above to view the conversation</p>
                </div>
            `;
            lucide.createIcons();
        }

        function renderConversation(traceId) {
            const conv = conversationsData[traceId];
            if (!conv) return;

            // Show and update meta bar
            const metaBar = document.getElementById('traceMetaBar');
            metaBar.style.display = 'flex';

            const statusEl = document.getElementById('traceStatus');
            statusEl.textContent = conv.success ? '‚úì Complete' : '‚úó Failed';
            statusEl.className = 'conv-status-badge ' + (conv.success ? 'success' : 'failed');

            document.getElementById('traceDuration').textContent = (conv.duration_ms / 1000).toFixed(1) + 's';
            document.getElementById('tracePersona').textContent = conv.persona;
            document.getElementById('traceTurnCount').textContent = conv.turn_count;

            // Render turns
            const timeline = document.getElementById('conversationTimeline');
            timeline.innerHTML = '';

            let currentTurnIdx = -1;
            conv.turns.forEach(msg => {
                if (msg.turn_index !== currentTurnIdx) {
                    currentTurnIdx = msg.turn_index;
                    timeline.appendChild(createConvTurnDivider(currentTurnIdx));
                }
                timeline.appendChild(createConvMessageCard(msg));
            });

            // Re-init Lucide icons
            lucide.createIcons();
        }

        function createConvTurnDivider(turnIdx) {
            const div = document.createElement('div');
            div.className = 'conv-turn-divider';
            div.innerHTML = `Turn ${turnIdx}`;
            return div;
        }

        function createConvMessageCard(msg) {
            const card = document.createElement('div');
            card.className = 'conv-message-card';

            const isAssistant = msg.role === 'assistant';

            // Actions section (collapsed by default)
            let actionsHtml = '';
            if (isAssistant && msg.actions && msg.actions.length > 0) {
                const actionItems = msg.actions.map(a => {
                    const iconName = a.startsWith('agent:') ? 'activity' :
                                    a.startsWith('span:') ? 'zap' :
                                    a.startsWith('tool:') ? 'wrench' : 'circle';
                    return `<div class="conv-action-item"><i data-lucide="${iconName}"></i>${escapeHtml(a)}</div>`;
                }).join('');

                actionsHtml = `
                    <div class="conv-actions-section">
                        <div class="conv-actions-header" onclick="toggleConvActions(this)">
                            <span class="conv-toggle-icon">‚ñ∂</span>
                            <i data-lucide="settings" class="conv-actions-icon"></i>
                            <span>Actions Used (${msg.actions.length})</span>
                        </div>
                        <div class="conv-actions-list">
                            ${actionItems}
                        </div>
                    </div>
                `;
            }

            // Metadata badge for debugging (thread_id, provider)
            let metadataBadge = '';
            if (msg.metadata && msg.metadata.thread_id) {
                const provider = msg.metadata.provider || '';
                const threadIdShort = msg.metadata.thread_id.substring(0, 8);
                metadataBadge = `<span class="conv-metadata-badge">${provider} | ${threadIdShort}...</span>`;
            }

            // Persona tag
            const personaTag = msg.persona ? `<span class="conv-persona-tag">${msg.persona}</span>` : '';

            card.innerHTML = `
                <div class="conv-message-header">
                    <div class="conv-role-indicator ${msg.role}">
                        <div class="conv-role-icon ${msg.role}">
                            <i data-lucide="${isAssistant ? 'bot' : 'user-round'}"></i>
                        </div>
                        <span>${msg.role.toUpperCase()}</span>
                        ${metadataBadge}
                    </div>
                    ${personaTag}
                </div>
                ${actionsHtml}
                <div class="conv-message-content">${escapeHtml(msg.content || '')}</div>
            `;
            return card;
        }

        function toggleConvActions(header) {
            const icon = header.querySelector('.conv-toggle-icon');
            const list = header.parentElement.querySelector('.conv-actions-list');
            list.classList.toggle('show');
            icon.classList.toggle('expanded');
        }
    </script>

    <!-- Trace Detail Modal -->
    <div id="traceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTraceId">Trace Details</h2>
                <button class="modal-close" onclick="closeTraceModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <p>Loading...</p>
            </div>
        </div>
    </div>

    <!-- Legend Modal -->
    <div class="modal-overlay" id="legendModal" onclick="closeLegendModal(event)">
        <div class="legend-modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Evaluation Criteria</h3>
                <button class="modal-close" onclick="closeLegendModal()">√ó</button>
            </div>
            <div class="legend-list">
                <div class="legend-item">
                    <span class="legend-icon pass">‚úì</span>
                    <div class="legend-content">
                        <div class="legend-label">Pass</div>
                        <div class="legend-desc">Metric meets quality threshold (Good / Appropriate)</div>
                    </div>
                </div>
                <div class="legend-item">
                    <span class="legend-icon fail">‚úó</span>
                    <div class="legend-content">
                        <div class="legend-label">Fail</div>
                        <div class="legend-desc">Metric below threshold (Bad / Inappropriate)</div>
                    </div>
                </div>
                <div class="legend-item">
                    <span class="legend-icon partial">!</span>
                    <div class="legend-content">
                        <div class="legend-label">Partial</div>
                        <div class="legend-desc">Partially met criteria (Fair / Needs improvement)</div>
                    </div>
                </div>
                <div class="legend-item">
                    <span class="legend-icon review">?</span>
                    <div class="legend-content">
                        <div class="legend-label">Review Needed</div>
                        <div class="legend-desc">Low confidence score, requires manual review</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Metric Criteria Modal -->
    <div class="modal-overlay" id="metricCriteriaModal" onclick="closeMetricModal(event)">
        <div class="legend-modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title" id="metricModalTitle">Metric Criteria</h3>
                <button class="modal-close" onclick="closeMetricModal()">√ó</button>
            </div>
            <div id="metricModalBody" style="margin-top: 1rem;">
                <!-- Content will be dynamically inserted -->
            </div>
        </div>
    </div>

    <script>
        function openLegendModal() {
            const modal = document.getElementById('legendModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeLegendModal(event) {
            const modal = document.getElementById('legendModal');
            if (!modal) return;

            // If no event, or event target is the overlay, close the modal
            if (!event || event.target === modal) {
                modal.classList.remove('active');
            }
        }

        // Close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const legendModal = document.getElementById('legendModal');
                if (legendModal) {
                    legendModal.classList.remove('active');
                }
                const metricModal = document.getElementById('metricCriteriaModal');
                if (metricModal) {
                    metricModal.classList.remove('active');
                }
            }
        });

        // Navigate to Metric Criteria Section
        function navigateToMetricCriteria(category) {
            // Navigate to eval-criteria section
            navigateTo('eval-criteria');

            // Scroll to the specific category after a short delay
            const targetId = 'criteria-' + category;
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                setTimeout(() => {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        // Metric Criteria Modal Functions
        function openMetricModal(category) {
            const modal = document.getElementById('metricCriteriaModal');
            const title = document.getElementById('metricModalTitle');
            const body = document.getElementById('metricModalBody');

            if (!modal || !title || !body) return;

            // Set title and content based on category
            const content = getMetricCriteriaContent(category);
            title.textContent = content.title;
            body.innerHTML = content.html;

            modal.classList.add('active');
        }

        function closeMetricModal(event) {
            const modal = document.getElementById('metricCriteriaModal');
            if (!modal) return;

            // If no event, or event target is the overlay, close the modal
            if (!event || event.target === modal) {
                modal.classList.remove('active');
            }
        }

        function getMetricCriteriaContent(category) {
            const criteria = {
                'completeness': {
                    title: 'Completeness Criteria',
                    html: `
                        <table class="metric-criteria-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Good</th>
                                    <th>Fair</th>
                                    <th>Poor</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="criteria-metric-name">Task Completion Rate</td>
                                    <td><span class="criteria-badge good">Good</span> ‚â•80%</td>
                                    <td><span class="criteria-badge fair">Fair</span> 60-80%</td>
                                    <td><span class="criteria-badge poor">Poor</span> &lt;60%</td>
                                </tr>
                            </tbody>
                        </table>
                    `
                },
                'correctness': {
                    title: 'Correctness Criteria',
                    html: `
                        <table class="metric-criteria-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Good</th>
                                    <th>Fair</th>
                                    <th>Poor/Critical</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="criteria-metric-name">Hallucination Rate</td>
                                    <td><span class="criteria-badge good">Good</span> ‚â§5%</td>
                                    <td><span class="criteria-badge fair">Fair</span> 5-15%</td>
                                    <td><span class="criteria-badge critical">Critical</span> &gt;15%</td>
                                </tr>
                                <tr>
                                    <td class="criteria-metric-name">Relevance Rate</td>
                                    <td><span class="criteria-badge good">Good</span> ‚â•90%</td>
                                    <td><span class="criteria-badge fair">Fair</span> 80-90%</td>
                                    <td><span class="criteria-badge poor">Poor</span> &lt;80%</td>
                                </tr>
                                <tr>
                                    <td class="criteria-metric-name">Tool Usage Appropriateness</td>
                                    <td><span class="criteria-badge good">Good</span> ‚â•90%</td>
                                    <td><span class="criteria-badge fair">Fair</span> 80-90%</td>
                                    <td><span class="criteria-badge poor">Poor</span> &lt;80%</td>
                                </tr>
                            </tbody>
                        </table>
                    `
                },
                'quality': {
                    title: 'Response Quality Criteria',
                    html: `
                        <table class="metric-criteria-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Good</th>
                                    <th>Fair</th>
                                    <th>Poor</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="criteria-metric-name">User Satisfaction Score</td>
                                    <td><span class="criteria-badge good">Good</span> ‚â•70%</td>
                                    <td><span class="criteria-badge fair">Fair</span> 50-70%</td>
                                    <td><span class="criteria-badge poor">Poor</span> &lt;50%</td>
                                </tr>
                                <tr>
                                    <td class="criteria-metric-name">Response Clarity</td>
                                    <td><span class="criteria-badge good">Good</span> ‚â•90%</td>
                                    <td><span class="criteria-badge fair">Fair</span> 80-90%</td>
                                    <td><span class="criteria-badge poor">Poor</span> &lt;80%</td>
                                </tr>
                                <tr>
                                    <td class="criteria-metric-name">Persona Consistency</td>
                                    <td><span class="criteria-badge good">Good</span> ‚â•70%</td>
                                    <td><span class="criteria-badge fair">Fair</span> 50-70%</td>
                                    <td><span class="criteria-badge poor">Poor</span> &lt;50%</td>
                                </tr>
                            </tbody>
                        </table>
                    `
                },
                'efficiency': {
                    title: 'Efficiency & Performance Criteria',
                    html: `
                        <p style="color: #6b7280; font-size: 13px; line-height: 1.6; margin-bottom: 1rem;">
                            Statistical analysis with outlier detection for performance metrics:
                        </p>
                        <table class="metric-criteria-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Outlier Threshold</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="criteria-metric-name">Output Tokens</td>
                                    <td><span class="criteria-badge fair">Verbose</span> &gt;2000 tokens</td>
                                    <td>Responses significantly longer than average</td>
                                </tr>
                                <tr>
                                    <td class="criteria-metric-name">Conversation Turns</td>
                                    <td><span class="criteria-badge fair">Complex</span> &gt;6 turns</td>
                                    <td>Multi-turn conversations requiring extended interaction</td>
                                </tr>
                                <tr>
                                    <td class="criteria-metric-name">Response Latency</td>
                                    <td><span class="criteria-badge fair">Slow</span> &gt;60s</td>
                                    <td>Response time exceeds acceptable performance threshold</td>
                                </tr>
                            </tbody>
                        </table>
                        <p style="color: #6b7280; font-size: 12px; line-height: 1.6; margin-top: 1rem;">
                            Persona Performance Gap shows relative performance differences across user personas (e.g., expert vs. novice).
                        </p>
                    `
                }
            };

            return criteria[category] || { title: 'Criteria', html: '<p>No criteria found.</p>' };
        }
    </script>
</body>
</html>